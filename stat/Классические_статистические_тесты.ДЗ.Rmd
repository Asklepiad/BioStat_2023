---
title: "Task 5"
author: "Oleg Arnaut"
date: "2023-11-26"
output: html_document
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(glue)
```

# Инструкции

Ниже приведены семь клинических гипотез. В качестве задания протестируйте их, используя соответствующие статистические критерии. Решение должно содержать все элементы алгоритма проверки статистических гипотез:

• Сформулируете нулевую и альтернативную гипотезы.
• Укажите уровень значимости α.
• Определите статистический тест (критерий) для проверки гипотезы. При необходимости аргументируйте выбор одностороннего теста. 
• Укажите критическое значение статистики (используйте распределения из материалов лекции).
• Определите наблюдаемое значение статистики.
• Оцените статистическую значимость (p-value и/или доверительный интервал).
• Оцените практическую значимость.


*Данные для анализа необходимо генерировать самостоятельно в соответствии с каждой представленной гипотезой. По возможности используйте пакет dplyr


# Гипотеза 1. Существует ассоциация между уровнем физической активности (бинарная переменная, физическая активность может быть 'высокой' и 'низкой') и частотой возникновения сердечно-сосудистых заболеваний у пациентов старше 50 лет. Попробуйте вариант с большими выборками (sample_size <- 100). Как изменится стратегия при малых выборках (sample_size <- 30) ? 

## Прелиминарии
Сравним два различных подхода -- сначала проверим собственно тест на ассоциацию признаков, затем сравним доли.

## Подход 1

### Гипотезы
> H0: У лиц старше 50 лет отсутствует ассоциация между уровнем физической активности и частотой возникновения ССЗ.
> H1: У лиц старше 50 лет имеется ассоциация между уровнем физической активности и частотой возникновения ССЗ.

### Статзначимость
Мы будем считать результаты тестов статистически значимыми при вероятности ошибки первого рода = 5%.
### Выбор теста
Для выборки в 100 человек будем использовать X2-Пирсона.
Для выборки в 30 человек используем его же, но с поправкой Йейтса на непрерывность (велик риск, что в ряде ячеек ожидаемое число наблюдений будет <=5)


### Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки 
sample_size <- 100

# Генерация данных по физической активности (бинарная переменная) в фиксированном соотношении 1:1
activity <- rep(c("passive","active"), each=sample_size/2)

test_df_100 <- tibble(activity)

# Генерация данных по наличию сердечно-сосудистых заболеваний (бинарная переменная)
# У активных людей меньше вероятность заболеть (0.5 vs 0.6)

test_df_100 <- test_df_100 %>% 
  rowwise() %>% 
  mutate(
    cardio = if_else(activity == "passive", 
                     sample(x = c("healthy","ill"), size = 1, prob = c(0.4, 0.6)),
                     sample(x = c("healthy","ill"), size = 1, prob = c(0.5, 0.5)))) %>% 
  ungroup

    
```



```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки
sample_size <- 30

# Генерация данных по физической активности (бинарная переменная) в фиксированном соотношении 1:1
activity <- rep(c("passive","active"), each=sample_size/2)

test_df_30 <- tibble(activity)

# Генерация данных по наличию сердечно-сосудистых заболеваний (бинарная переменная)
# У активных людей меньше вероятность заболеть (0.5 vs 0.6)

test_df_30 <- test_df_30 %>% 
  rowwise() %>% 
  mutate(
    cardio = if_else(activity == "passive", 
                     sample(x = c("healthy","ill"), size = 1, prob = c(0.4, 0.6)),
                     sample(x = c("healthy","ill"), size = 1, prob = c(0.5, 0.5)))) %>% 
  ungroup
    
```




### Решение

Число степеней свободы для заданного распределения X2 равно (r - 1)(c - 1) = 1

```{r}
df = 1
x_values <- seq(0, 7, by = 0.01)
pdf_chi_squared <- dchisq(x_values, df)
pdf_data <- tibble(x = x_values, 
                   pdf_ = pdf_chi_squared)
quantiles <- c(0.025, 0.975)
thresholds <- qchisq(quantiles, df)

chi_base <- ggplot(pdf_data) +
  geom_line(aes(x = x, y = pdf_), size = 1) +
  geom_vline(xintercept = c(thresholds[1], thresholds[2]),
             color = c("red", "red"))+
  annotate("text", x = thresholds[1] - 0.2, y = 2.5, label = sprintf("Q(%.3f)=%.2f", quantiles[1], thresholds[1]), size = 5, angle = 90) +
  annotate("text", x = thresholds[2] - 0.2, y = 2.5, label = sprintf("Q(%.3f)=%.2f", quantiles[2], thresholds[2]), size = 5, angle = 90)+
  labs(title = "PDF распределения хи-квадрат", 
       x = "Значение статистики",
       y = "Плотность вероятности")+
  theme_bw()
chi_base
```

### Критическое значение статистики
Критические значения статистики: 0 и 5.02

### Наблюдаемое значение статистики
```{r}
test_df_100 <- test_df_100 %>% 
  group_by(activity) %>% 
  count(cardio) %>% 
  pivot_wider(names_from = cardio, values_from = n) %>% 
  tibble::column_to_rownames("activity")
chi_100 <- chisq.test(test_df_100, correct = FALSE)

test_df_30 <- test_df_30 %>% 
  group_by(activity) %>% 
  count(cardio) %>% 
  pivot_wider(names_from = cardio, values_from = n) %>% 
  tibble::column_to_rownames("activity")
chi_30 <- chisq.test(test_df_30, correct = TRUE)

glue("Значение статистики X2 для 100 наблюдений равно {chi_100$statistic %>% round(2)} (p-уровень значимости равен {chi_100$p.value %>% round(2)}, число степеней свободы -- 1)\n\
Значение статистики X2 для 30 наблюдений равно {chi_30$statistic %>% round(2)} (p-уровень значимости равен {chi_30$p.value %>% round(2)}, число степеней свободы -- 1)")
```

### Оценка статзначимости/ДИ

p-уровень значимости больше установленного нами порога в 0.05 для обеих выборок.

```{r}
chi_base+
  geom_vline(xintercept = chi_100$statistic, color = "green", linetype="dashed")

chi_base+
  geom_vline(xintercept = chi_30$statistic, color = "green", linetype="dashed")
```


### Оценка практической значимости

Несмотря на существующие в действительности различия, тесту хи-квадрат недостает мощности, чтобы их выявить.

## Подход 2.

Теперь попробуем сравнить доли. 

### Гипотезы
> H0: Частота возникновения ССЗ одинакова у лиц старше 50 лет как с высоким уровнем физической активности, так и без оного.
> H1: Частота возникновения ССЗ неодинакова у лиц старше 50 лет как с высоким уровнем физической активности, так и без оного.

### Статзначимость
Мы будем считать результаты тестов статистически значимыми при вероятности ошибки первого рода = 5%.

### Выбор теста.
Доли будем сравнивать при помощи z-теста (для выборки в 100 человек) и t-теста (для малой выборки размером в 30 человек). Использование t-теста на малых выборках объясняется более тяжелыми хвостами t-распределения, что смещает квантили в более маргинальные точки на оси абсцисс, по сравнению с нормальным распределением.

### Генерация данных

#СДЕЛАТЬ ЛАТЕХ
Вспомним, что формула z-теста для доли -- (p1-p2) - (p1-p2) / sqrt(p*q*(1/n1 + 1/n2))

```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки 
sample_size <- 100

# Генерация данных по физической активности (бинарная переменная) в фиксированном соотношении 1:1
# Генерация данных по наличию сердечно-сосудистых заболеваний (бинарная переменная)
# У активных людей меньше вероятность заболеть (0.5 vs 0.6)

# Т.о. доля здоровых людей в популяции активных людей равна 0.5, а в популяции пассивных -- 0.4.

p1 <- 0.5 # Доля здоровых людей среди активных
p2 <- 0.4 # Доля здоровых людей среди пассивных
num1 <- p1 * 100
num2 <- p2 * 100
```

```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки
sample_size_2 <- 30

p1_2 <- 0.5 # Доля здоровых людей среди активных
p2_2 <- 0.4 # Доля здоровых людей среди пассивных
num1_2 <- p1_2 * 30
num2_2 <- p2_2 * 30
    
```

### Критическое значение статистики
```{r}
x_values <- seq(-4, 4, by = 0.01)
pdf_normal <- dnorm(x_values, mean = 0, sd = 1)
quantiles <- c(0.025, 0.975)
quantile_values <- qnorm(quantiles, mean = 0, sd = 1)
pdf_data <- data.frame(x = x_values, Probability = pdf_normal)
```
Критические значения статистики для выборки в 100 человек -- -1.96 и 1.96 (весьма ожидаемо).

```{r}
pmf_binomial <- dbinom(1:sample_size_2, size = sample_size_2, prob = p1_2)
pmf_data <- data.frame(x = 1:sample_size_2, Вероятность = pmf_binomial)
```

### Наблюдаемое значение статистики

```{r}
p <- (num1+num2)/(sample_size*2)
z <- (p1 - p2) / sqrt((p * (1 - p)) * (2 * 1/sample_size))
pval <- pdf_data[pdf_data["x"] == round(z,2)][2]
print(z)
print(pval)

```

z-статистика критерия для выборки в 100 человек в нашем случае = 1.42

```{r}
p_2 <- (num1_2+num2_2)/(sample_size_2*2)
z_2 <- (p1_2 - p2_2) / sqrt((p_2 * (1 - p_2)) * (2 * 1/sample_size_2))
pval_2 <- pdf_data[pdf_data["x"] == round(z_2,2)][2]
print(z_2)
print(pval_2)
```


### Оценка статзначимости/ДИ

p-значение для выборки в 100 человек в данном случае равно 0.14

### Оценка практической значимости

z-тест также не детектировал различия между группами. Вероятно, для обнаружения такого размера эффекта нужна выборка большего размера. 


# Гипотеза 2. Применение нового метода лечения для пациентов с артериальной гипертензией приведет к уменьшению среднего артериального давления по сравнению с пациентами, получающими стандартное лечение.

## Гипотезы
## Статзначимость
Мы будем считать результаты тестов статистически значимыми при вероятности ошибки первого рода = 5%.
## Выбор теста
## Критическое значение статистики
## Наблюдаемое значение статистики
## Оценка статзначимости/ДИ
## Оценка практической значимости

## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки (в каждой группе)
sample_size <- 80


# В популяции c экспериментальным методом лечения средний уровень систолического артериального давления меньше (130 vs 135 mm) 
# Генерация данных для группы с новым методом лечения 
group1 <- rnorm( ... )  # экспериментальная группа

# Генерация данных для группы со стандартным лечением
group2 <- rnorm( ... )  # контрольная группа

```

## Решение

```{r}


```


# Гипотеза 3. Внедрение программы реабилитации для пациентов с хронической болью в спине приведет к улучшению их физической активности (предположим что физическую активность можно оценить по шкале 0-100)

## Гипотезы
## Статзначимость
Мы будем считать результаты тестов статистически значимыми при вероятности ошибки первого рода = 5%.
## Выбор теста
## Критическое значение статистики
## Наблюдаемое значение статистики
## Оценка статзначимости/ДИ
## Оценка практической значимости

## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки 
sample_size <- 30

# В популяции до реабилитации средний уровень физической активности меньше (50 vs 60) 
# Генерация данных до реабилитации
before <- rbinom( ... )

# Генерация данных после реабилитации
after <- rbinom( ... )  


```

## Решение

```{r}


```

# Гипотеза 4. Применение нового метода лечения для пациентов с инфарктом миокарда увеличит долю вернувшихся к нормальной физической активности 

## Гипотезы
H0: Доля пациентов, вернувшихся к нормальной физической активности одинакова в группе старого метода лечения, и в группе нового метода лечения.

## Статзначимость
Мы будем считать результаты тестов статистически значимыми при вероятности ошибки первого рода = 5%.

## Выбор теста
Для сравнения долей будем использовать z-тест.

## Критическое значение статистики
```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки
sample_size <- 200


# В популяции экспериментального лечения вероятность нормальной физической активности больше (0.7 vs 0.65)
# Генерация данных по статусу лечение (бинарная переменная, новый метод или стандарт) в фиксированном соотношении 1:1
treatment <- rep(c("old", "new"), each = sample_size/2)
p1 <- 0.5 # Доля здоровых людей среди активных
p2 <- 0.4 # Доля здоровых людей среди пассивных
num1 <- p1 * 100
num2 <- p2 * 100
# Генерация данных по физической активности после лечения (бинарная переменная)
activity <- ...

    
```



## Наблюдаемое значение статистики


## Оценка статзначимости/ДИ


## Оценка практической значимости

## Генерация данных 



## Решение

```{r}


```

# Гипотеза 5. Применение медитации в течение 8 недель повлияет на наличие стресса (есть/нет) у лиц с высоким уровнем тревожности.

## Гипотезы
## Статзначимость
Мы будем считать результаты тестов статистически значимыми при вероятности ошибки первого рода = 5%.
## Выбор теста
## Критическое значение статистики
## Наблюдаемое значение статистики
## Оценка статзначимости/ДИ
## Оценка практической значимости

## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки
sample_size <- 50

# Генерация данных до медитации (бинарная переменная) в фиксированном соотношении 1:1
before <- ...

# Генерация данных после медитации (бинарная переменная). После медитации вероятность наличия стресса меньше (0.2 vs 0.4)
after <- ...

```

## Решение

```{r}


```

# Гипотеза 6. Применение альтернативного метода лечения для пациентов с биполярным расстройством приведет к значимому изменению уровня симптомов депрессии по отношению к группе, прошедшей стандартное лечение (депрессию можно определить по шкале от 0 до 100, при этом исследователь должен избежать любых предположений (кроме i.i.d.)).

## Гипотезы
## Статзначимость
Мы будем считать результаты тестов статистически значимыми при вероятности ошибки первого рода = 5%.
## Выбор теста
## Критическое значение статистики
## Наблюдаемое значение статистики
## Оценка статзначимости/ДИ
## Оценка практической значимости

## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки для каждой группы
sample_size <- 20


# В популяции c экспериментальным методом лечения средний депрессии меньше (55 vs 68) 
# Генерация данных для экспериментальной группы 
group1 <- ...  # экспериментальная группа

# Генерация данных для группы со стандартным лечением
group2 <- ...  # контрольная группа

```

## Решение

```{r}


```


# Гипотеза 7. Длительность сна (в часах) ассоциирована с уровенем стресса у студентов (шкала с нормальным распределением)

## Гипотезы
## Статзначимость
Мы будем считать результаты тестов статистически значимыми при вероятности ошибки первого рода = 5%.
## Выбор теста
## Критическое значение статистики
## Наблюдаемое значение статистики
## Оценка статзначимости/ДИ
## Оценка практической значимости

## Генерация данных  

```{r}

library(mvtnorm) # библиотека mvtnorm для работы с многомерным нормальным распределением

# Воспроизводимость результатов
set.seed(42)

# Размер выборки
sample_size <- 100

# Средние значения для длительности сна (HoursOfSleep) и уровня стресса (StressLevel) в популяции
means <- c(7, 5)  

# Матрица ковариации. В ислледуемой популяции HoursOfSleep и StressLevel ассоциированы отрицательно (r = -0.5)
cov_matrix <- matrix(c(..., ..., ..., ...), nrow = 2)

df <- rmvnorm(n = ..., 
              mean = ..., 
              sigma = ...) %>% 
      as_tibble() %>%
      setNames(c("HoursOfSleep", "StressLevel"))  

```
## Решение (дополните решение визуализацией)

```{r}


```









