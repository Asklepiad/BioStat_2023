---
title: "Task 5"
author: "Oleg Arnaut"
date: "2023-11-26"
output: html_document
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(glue)
```

# Инструкции

Ниже приведены семь клинических гипотез. В качестве задания протестируйте их, используя соответствующие статистические критерии. Решение должно содержать все элементы алгоритма проверки статистических гипотез:

• Сформулируете нулевую и альтернативную гипотезы.
• Укажите уровень значимости α.
• Определите статистический тест (критерий) для проверки гипотезы. При необходимости аргументируйте выбор одностороннего теста. 
• Укажите критическое значение статистики (используйте распределения из материалов лекции).
• Определите наблюдаемое значение статистики.
• Оцените статистическую значимость (p-value и/или доверительный интервал).
• Оцените практическую значимость.


*Данные для анализа необходимо генерировать самостоятельно в соответствии с каждой представленной гипотезой. По возможности используйте пакет dplyr

**Код для визуализации практически целиком позаимствован из лекции по классическим статистическим тестам

# Гипотеза 1. Существует ассоциация между уровнем физической активности (бинарная переменная, физическая активность может быть 'высокой' и 'низкой') и частотой возникновения сердечно-сосудистых заболеваний у пациентов старше 50 лет. Попробуйте вариант с большими выборками (sample_size <- 100). Как изменится стратегия при малых выборках (sample_size <- 30) ? 

### Гипотезы
> H0: У лиц старше 50 лет отсутствует ассоциация между уровнем физической активности и частотой возникновения ССЗ.
> H1: У лиц старше 50 лет имеется ассоциация между уровнем физической активности и частотой возникновения ССЗ.

### Статзначимость
Мы будем считать результаты тестов статистически значимыми при вероятности ошибки первого рода = 5%.
### Выбор теста
Для выборки в 100 человек будем использовать X2-Пирсона.
Для выборки в 30 человек используем его же, но с поправкой Йейтса на непрерывность (велик риск, что в ряде ячеек ожидаемое число наблюдений будет <=5)


### Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки 
sample_size <- 100

# Генерация данных по физической активности (бинарная переменная) в фиксированном соотношении 1:1
activity <- rep(c("passive","active"), each=sample_size/2)

test_df_100 <- tibble(activity)

# Генерация данных по наличию сердечно-сосудистых заболеваний (бинарная переменная)
# У активных людей меньше вероятность заболеть (0.5 vs 0.6)

test_df_100 <- test_df_100 %>% 
  rowwise() %>% 
  mutate(
    cardio = if_else(activity == "passive", 
                     sample(x = c("healthy","ill"), size = 1, prob = c(0.4, 0.6)),
                     sample(x = c("healthy","ill"), size = 1, prob = c(0.5, 0.5)))) %>% 
  ungroup

    
```



```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки
sample_size <- 30

# Генерация данных по физической активности (бинарная переменная) в фиксированном соотношении 1:1
activity <- rep(c("passive","active"), each=sample_size/2)

test_df_30 <- tibble(activity)

# Генерация данных по наличию сердечно-сосудистых заболеваний (бинарная переменная)
# У активных людей меньше вероятность заболеть (0.5 vs 0.6)

test_df_30 <- test_df_30 %>% 
  rowwise() %>% 
  mutate(
    cardio = if_else(activity == "passive", 
                     sample(x = c("healthy","ill"), size = 1, prob = c(0.4, 0.6)),
                     sample(x = c("healthy","ill"), size = 1, prob = c(0.5, 0.5)))) %>% 
  ungroup
    
```




### Решение

Число степеней свободы для заданного распределения X2 равно (r - 1)(c - 1) = 1

```{r}
df = 1
x_values <- seq(0, 7, by = 0.01)
pdf_chi_squared <- dchisq(x_values, df)
pdf_data <- tibble(x = x_values, 
                   pdf_ = pdf_chi_squared)
quantiles <- c(0.025, 0.975)
thresholds <- qchisq(quantiles, df)

chi_base <- ggplot(pdf_data) +
  geom_line(aes(x = x, y = pdf_), size = 1) +
  geom_vline(xintercept = c(thresholds[1], thresholds[2]),
             color = c("red", "red"))+
  annotate("text", x = thresholds[1] - 0.2, y = 2.5, label = sprintf("Q(%.3f)=%.2f", quantiles[1], thresholds[1]), size = 5, angle = 90) +
  annotate("text", x = thresholds[2] - 0.2, y = 2.5, label = sprintf("Q(%.3f)=%.2f", quantiles[2], thresholds[2]), size = 5, angle = 90)+
  labs(title = "PDF распределения хи-квадрат", 
       x = "Значение статистики",
       y = "Плотность вероятности")+
  theme_bw()
chi_base
```

### Критическое значение статистики
Критические значения статистики: 0 и 5.02

### Наблюдаемое значение статистики
```{r}
test_df_100 <- test_df_100 %>% 
  group_by(activity) %>% 
  count(cardio) %>% 
  pivot_wider(names_from = cardio, values_from = n) %>% 
  tibble::column_to_rownames("activity")
chi_100 <- chisq.test(test_df_100, correct = FALSE)

test_df_30 <- test_df_30 %>% 
  group_by(activity) %>% 
  count(cardio) %>% 
  pivot_wider(names_from = cardio, values_from = n) %>% 
  tibble::column_to_rownames("activity")
chi_30 <- chisq.test(test_df_30, correct = TRUE)

glue("Значение статистики X2 для 100 наблюдений равно {chi_100$statistic %>% round(2)} (p-уровень значимости равен {chi_100$p.value %>% round(2)}, число степеней свободы -- 1)\n\
Значение статистики X2 для 30 наблюдений равно {chi_30$statistic %>% round(2)} (p-уровень значимости равен {chi_30$p.value %>% round(2)}, число степеней свободы -- 1)")
```

### Оценка статзначимости/ДИ

p-уровень значимости больше установленного нами порога в 0.05 для обеих выборок.

```{r}
chi_base+
  geom_vline(xintercept = chi_100$statistic, color = "green", linetype="dashed")

chi_base+
  geom_vline(xintercept = chi_30$statistic, color = "green", linetype="dashed")
```


### Оценка практической значимости

Несмотря на существующие в действительности различия, тесту хи-квадрат недостает мощности, чтобы их выявить.

# Гипотеза 2. Применение нового метода лечения для пациентов с артериальной гипертензией приведет к уменьшению среднего артериального давления по сравнению с пациентами, получающими стандартное лечение.

## Гипотезы
H0: Среднее АД в группе нового лечения не меньше, чем в группе стандартного лечения.
H1: Среднее АД в группе нового лечения меньше, чем в группе стандартного лечения.

## Статзначимость
Мы будем считать результаты тестов статистически значимыми при вероятности ошибки первого рода = 5%.

## Выбор теста
Для сравнения средних будем использовать односторонний t-тест Стьюдента. Если бы мы проводили КИ в фармакологии, то несмотря на заявленную гипотезу, должны были бы использовать 2-сторонний тест, поскольку регуляторные требования предписывают проверять и вторую часть гипотезы тоже (а если препарат не только не улучшает состояние пациента, но и ухудшает его?).



## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки (в каждой группе)
sample_size <- 80
sd_x = 7
sd_y = 12

# В популяции c экспериментальным методом лечения средний уровень систолического артериального давления меньше (130 vs 135 mm) 
# Генерация данных для группы с новым методом лечения 
group1 <- rnorm(sample_size, mean=130, sd_x = 7)  # экспериментальная группа

# Генерация данных для группы со стандартным лечением
group2 <- rnorm(sample_size, mean=135, sd_y = 12)  # контрольная группа
```

## Критическое значение статистики
```{r}
# Сначала посчитаем число степеней свободы при помощи теста Уэлча
numerator <- ((sd_x**2 / sample_size) + (sd_y**2 / sample_size))**2
denominator <- (sd_x**4 / (sample_size**2 * (sample_size))) + (sd_y**4 / (sample_size**2 * (sample_size - 1)))

df <- numerator / denominator

# Вычислим критическое значение статистики

quantiles = c(0.05, 1)
thresholds = qt(quantiles, df)

glue("Критическим значением статистики в нашем случае являются {thresholds[1] %>% round(2)} и плюс-бесконечность.")
```

## Наблюдаемое значение статистики
```{r}
# t.test(group1, group2, alternative = "less")


```

Наблюдаем, что значение статистики равно -2.08, что меньше критического значения (p=0.019). Любопытно, что вычисленное внутри теста значение статистики Уэлча отличается от нашего.

## Оценка статзначимости/ДИ
Наблюдаем статистически значимые различия при заданной нами альфе.

## Оценка практической значимости
Различия в приблизительно 4 ед мм.рт.ст не выглядят клинически значимыми. Мы детектируем эффект благодаря достаточно большой выборке и нормальности исходных распределений.


# Гипотеза 3. Внедрение программы реабилитации для пациентов с хронической болью в спине приведет к улучшению их физической активности (предположим что физическую активность можно оценить по шкале 0-100)

## Гипотезы
H0: Средняя физическая активность у пациентов с хронической болью в спине не лучше у пациентов после прохождения программы реабилитации по сравнению с состоянием до реабилитации.
H1: Средняя физическая активность у пациентов с хронической болью в спине лучше у пациентов после прохождения программы реабилитации по сравнению с состоянием до реабилитации.

## Статзначимость
Мы будем считать результаты тестов статистически значимыми при вероятности ошибки первого рода = 5%.

## Выбор теста
Для сравнения средних вновь прибегнем к t-тесту, но уже для связанных выборок. Он снова будет односторонним, поскольку нам интересно отклонение только в сторону больших значений, и снова, если бы речь шла о КИ, мы были бы, несмотря на это, вынуждены бы были использовать двусторонний тест.

## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки 
sample_size <- 30

# В популяции до реабилитации средний уровень физической активности меньше (50 vs 60) 
# Генерация данных до реабилитации
before <- rnorm(sample_size, mean = 50, sd = 12) %>% round(0)

# Генерация данных после реабилитации
after <- rnorm(sample_size, mean = 60, sd = 12) %>% round(0)
```


## Критическое значение статистики
Поскольку дисперсии в группах на сей раз равны df = 29 (30 - (2-1)).
```{r}
df <- sample_size - 1
quantiles = c(0, 0.9)
thresholds = qt(quantiles, df)
glue("Критическими значениями статистики в нашем случае являются минус-бесконечность и  {thresholds[2] %>% round(2)}.")
```

## Наблюдаемое значение статистики
```{r}
d_dif = after - before
d_mean <- mean(d_dif)
disp <- sum((d_dif - d_mean)**2)/(df)

t = d_mean / (sqrt(disp/sample_size))
glue("Наблюдаемое значение статистики -- {t %>% round(2)}")
```


## Оценка статзначимости/ДИ
Различия статзначимы при заданной нами альфе

## Оценка практической значимости
Мне сложно оценить, поскольку не хватает доменных знаний о данной шкале. Интуитивно кажется, что на не очень больших выборках незначительные отличия бы выявились с меньшей вероятностью, но здесь важно правильно интерпретировать это различие.

Стоит обратить внимание на отсутствие группы контроля, что выглядит серьезным упущением дизайна (хотя рассмотрение данного вопроса и не входит в выполнение домашнего задания). Мы не можем с уверенностью судить, что по прошествии опредленного количества времени у пациента с хронической болью по тем или иным причинам не наступает повышение физической активности.

```{r}
glue("Размер эффекта -- {d_mean %>% round(2)} балла.")
```



# Гипотеза 4. Применение нового метода лечения для пациентов с инфарктом миокарда увеличит долю вернувшихся к нормальной физической активности 

## Гипотезы
H0: Доля пациентов, вернувшихся к нормальной физической активности не больше в группе нового метода лечения, по сравнению с группой старого метода лечения.
H1: Доля пациентов, вернувшихся к нормальной физической активности больше в группе нового метода лечения, по сравнению с группой старого метода лечения.

## Статзначимость
Мы будем считать результаты тестов статистически значимыми при вероятности ошибки первого рода = 5%.

## Выбор теста
Для сравнения долей будем использовать односторонний z-тест (односторонний, поскольку мы проверяем, что доля именно вырастет, а не просто изменится).

## Генерация данных
```{r}
# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки
sample_size <- 200


# В популяции экспериментального лечения вероятность нормальной физической активности больше (0.7 vs 0.65)
# Генерация данных по статусу лечение (бинарная переменная, новый метод или стандарт) в фиксированном соотношении 1:1
treatment <- rep(c("old", "new"), each = sample_size/2)

# Генерация данных по физической активности после лечения (бинарная переменная)
activity <- c(
  sample(c("non_reab", "reab"), size = sample_size/2, prob = c(0.35, 0.65), replace = TRUE),
  sample(c("non_reab", "reab"), size = sample_size/2, prob = c(0.3, 0.7), replace = TRUE)
)
df_4 <- tibble(treatment, activity)
```

## Критическое значение статистики
```{r}
quantiles <- c(0, 0.95)
quantile_values <- qnorm(quantiles, mean = 0, sd = 1)
glue("Критические значения z-статистики в нашем случае равны {quantile_values[1] %>% round(2)} и {quantile_values[2] %>% round(2)}")
```


## Наблюдаемое значение статистики
```{r}
p_s <- df_4 %>% 
  group_by(treatment) %>% 
  count(activity) %>% 
  mutate(proportion = n/sum(n)) %>% 
  filter(activity == "reab") %>% 
  ungroup %>% 
  select(proportion, n)
p1 <- p_s[1,1] %>% pull
p2 <- p_s[2,1] %>% pull
num1 <- p_s[1,2] %>% pull
num2 <- p_s[2,2] %>% pull

p <- (num1+num2)/(sample_size)
z <- (p1 - p2) / sqrt((p * (1 - p)) * (2 * 1/(sample_size/2)))

glue("Наблюдаемое значение статистики равно {z %>% round(2)}, что меньше критического значения для правой границы")
```


## Оценка статзначимости/ДИ

Поскольку наблюдаемое значение статистики находится между предельными значениями, статистическая значимость отсутствует.

## Оценка практической значимости

Насколько мы знаем из процесса генерации данных реальные различия между группами есть, однако нам недостает мощности (и более "правильного" сида, да), чтобы ее детектировать.


# Гипотеза 5. Применение медитации в течение 8 недель повлияет на наличие стресса (есть/нет) у лиц с высоким уровнем тревожности.

## Гипотезы
H0: Доля лиц с высоким уровнем тревожности после медитации не отличается от доли лиц с высоким уровнем тревожности до медитации.
H1: Доля лиц с высоким уровнем тревожности после медитации отличается от доли лиц с высоким уровнем тревожности до медитации.

## Статзначимость
Мы будем считать результаты тестов статистически значимыми при вероятности ошибки первого рода = 5%.

## Выбор теста
Для оценки разницы долей на повторяющихся выборках будем использовать тест Мак-Немара.

## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки
sample_size <- 50

# Генерация данных до медитации (бинарная переменная) в фиксированном соотношении 1:1
## Видимо, все же 2:3, потому что ниже упоминается вероятность в 0.4 для вероятности стресса
before <- sample(x = 0:1, size = sample_size, prob = c(0.6, 0.4), replace = TRUE)

# Генерация данных после медитации (бинарная переменная). После медитации вероятность наличия стресса меньше (0.2 vs 0.4)
after <- sample(x = 0:1, size = sample_size, prob = c(0.8, 0.2), replace = TRUE)

df <- tibble(before, after) %>% 
  group_by(before, after) %>% 
  count %>% 
  ungroup
```

## Критическое значение статистики
Табличное значение для альфы = 0.05 и df = 1 -- 3.84.

## Наблюдаемое значение статистики
```{r, warning=FALSE}
b <- df %>% filter(before == 0, after == 1) %>% select(n) %>% pull
c <- df %>% filter(before == 1, after == 0) %>% select(n) %>% pull

mn <- ((b-c)**2)/(b+c)

glue("Наблюдаемое значение критерия {mn %>% round(2)}")
```


## Оценка статзначимости/ДИ
```{r}
p-уровень значимости меньше заданного нами порогового значения, поскольку критическое значение статистики значительно меньше наблюдаемого.

glue("P-уровень значимости {mcnemar.test(matrix(df %>% select(n) %>% pull, nrow=2), correct=FALSE)$p.value %>% round(5)}")
```


## Оценка практической значимости

```{r}
glue("У {b} человек из {sample_size} в исходной выборке после медитации уровень тревожности вырос, у {c} человек снизился. Это можно трактовать как позитивное влияние медитации на уровень тревожности.")
```


# Гипотеза 6. Применение альтернативного метода лечения для пациентов с биполярным расстройством приведет к значимому изменению уровня симптомов депрессии по отношению к группе, прошедшей стандартное лечение (депрессию можно определить по шкале от 0 до 100, при этом исследователь должен избежать любых предположений (кроме i.i.d.)).

## Гипотезы
H0: Отсутствует вероятностное доминирование уровня симптомов депрессии в группе альтернативного лечения относительно группы стандартного лечения.
H1: Наличествует вероятностное доминирование уровня симптомов депрессии в группе альтернативного лечения относительно группы стандартного лечения.

## Статзначимость
Мы будем считать результаты тестов статистически значимыми при вероятности ошибки первого рода = 5%.

## Выбор теста
Для проверки гипотезы на вероятностное доминирование изберем тест Манна-Уитни, поскольку он не требует допущений о распределении выборок и их дисперсий.

## Генерация данных 

```{r}
# Воспроизводимость результатов
set.seed(42)

# Размер выборки для каждой группы
sample_size <- 20


# В популяции c экспериментальным методом лечения средний уровень депрессии меньше (55 vs 68) 
# Генерация данных для экспериментальной группы 
group1 <- sort(rnorm(sample_size, mean = 55, sd = 7))  # экспериментальная группа

# Генерация данных для группы со стандартным лечением
group2 <- sort(rnorm(sample_size, mean = 68, sd = 7))  # контрольная группа

df <- tibble(tr_type = rep(c("exp", "st"), each = sample_size), bar = c(group1, group2))
```

## Критическое значение статистики

Табличное значение статистики критерия Манна-Уитни для двухвыборочного теста при уровне значимости 0.05 и размере выборок равных 20 -- 127.
[Источник.](https://real-statistics.com/statistics-tables/mann-whitney-table/)

## Наблюдаемое значение статистики
```{r}
# wilcox.test(group1, group2)
# result_vector <- (group1 - group2) %>%  round(2)
# signs <- sapply(result_vector, function(x) if_else(x >= 0, 1, -1))
# ranks <- dense_rank(-result_vector)
# (ranks * signs) %>% sum %>%  abs

df_res <- df %>% 
  arrange(bar) %>% 
  mutate(rank_c = 1:(sample_size*2)) %>% 
  group_by(tr_type) %>% 
  summarise(R = sum(rank_c))

R1 = df_res[1,2] %>% pull
R2 = df_res[2,2] %>% pull

U = min((sample_size**2 + (sample_size*(sample_size + 1)/2) - R1), (sample_size**2 + (sample_size*(sample_size + 1)/2) - R2))
```


## Оценка статзначимости/ДИ

```{r}
glue("P-уровень значимости {wilcox.test(group1, group2)$p.value %>% round(5)}")
```


## Оценка практической значимости

У меня отсутствуют достаточные знания в доменной области (неназванный тест БАР от 1 до 100), чтобы оценить, насколько значимы результаты. Размер эффекта можно косвенно оценить по данным квантилей для обеих выборок.

```{r}
qt1 <- quantile(group1, probs = seq(0,1,0.25))
qt2 <- quantile(group2, probs = seq(0,1,0.25))
print("Квантили для экспериментального лечения")
qt1 
print("Квантили для стандартного лечения")
qt2
```

Видим, что квантили упомянутой шкалы для экспериментального лечения во всех случаях ниже.



# Гипотеза 7. Длительность сна (в часах) ассоциирована с уровенем стресса у студентов (шкала с нормальным распределением)

## Гипотезы
H0: Отсутствует связь между длительностью сна в часах и уровнем стресса у студентов.
H1: Существует взаимосвязь между длительностью сна в часах и уровнем стресса у студентов.
## Статзначимость
Мы будем считать результаты тестов статистически значимыми при вероятности ошибки первого рода = 5%.
## Выбор теста
Если мы предполагаем наличие линейной связи, мы можем использовать коэффициент корреляции Пирсона в качестве меры оценки ассоциации наших переменных.

## Генерация данных 

```{r}

library(mvtnorm) # библиотека mvtnorm для работы с многомерным нормальным распределением

# Воспроизводимость результатов
set.seed(42)

# Размер выборки
sample_size <- 100

# Средние значения для длительности сна (HoursOfSleep) и уровня стресса (StressLevel) в популяции
means <- c(7, 5)  

# Матрица ковариации. В ислледуемой популяции HoursOfSleep и StressLevel ассоциированы отрицательно (r = -0.5)
cov_matrix <- matrix(c(1, -0.5, -0.5, 1.5), nrow = 2, byrow=2)

df <- rmvnorm(n = 55, 
              mean = means, 
              sigma = cov_matrix) %>% 
      as_tibble() %>%
      setNames(c("HoursOfSleep", "StressLevel")) %>% 
  mutate(HoursOfSleep = HoursOfSleep %>% round(2),
         StressLevel = StressLevel %>% round(2))

```

## Критическое значение статистики
```{r}
df_ = nrow(df) - 2    # Число степеней свободы
quantiles <- c(0.025, 0.975)  # Квантили для альфы в 5%
cr_v <- qt(quantiles, df_)   # Критические значения
glue("Критические значения статистики равны {cr_v[1] %>% round(2)} и {cr_v[2] %>% round(2)}.")

```


## Наблюдаемое значение статистики
```{r}
pearson_cor <- cor.test(df$HoursOfSleep, df$StressLevel, method = "pearson")
glue("Наблюдаемое значение к.к. Пирсона = {pearson_cor$estimate %>% round(2)}")

# Расчитаем t-значение для r-статистики Пирсона
t_r <- pearson_cor$estimate / sqrt((1 - pearson_cor$estimate**2)/(df_))
glue("Наблюдаемое значение статистики = {t_r %>% round(2)}")
```

## Оценка статзначимости/ДИ
```{r}
glue("p-уровень значимости = {pearson_cor$p.value %>% round(5)}")
```

## Решение (дополните решение визуализацией)

```{r}
df %>% 
  ggplot()+
  geom_point(aes(x=HoursOfSleep, y=StressLevel))+
  geom_smooth(aes(x=HoursOfSleep, y=StressLevel), method="lm")

```

## Оценка практической значимости

Можно отметить, что  уровень стресса снижается при повышении часов ночного сна. Вместе с тем я не имею достаточно квалификации в оценке данной шкалы стресса, чтобы говорить о практической значимости изменений (насколько 3 балла по шкале стресса "лучше", чем 6 баллов?).







