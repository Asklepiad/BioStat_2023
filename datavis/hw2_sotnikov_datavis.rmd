---
title: "hw2_sotnikov_datavis"
author: "Bogdan Sotnikov"
date: '2023-11-12'
output:
  html_document:
    toc: TRUE
    theme:
      bootswatch: flatly
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
lapply(c("ggplot2", "readr", "psych", "glue", "tibble", "stats", "tidyr", "plotly", "ggbeeswarm", "stringr", "reshape", "RColorBrewer", "Hmisc", "purrr", "ggcorrplot", "ggpubr", "rstatix", "car", "dplyr", "factoextra", "pheatmap", "FactoMineR", "ggbiplot", "ggfortify", "GGally", "tidymodels", "embed"), require, character.only=TRUE)
options(scipen = 999)
```

# 1 Чтение и предобработка данных

Подгружаем датасет

```{r}
led <- read_rds("./life_expectancy_data.RDS")
```

Смотрим на переменные

```{r}
str(led)
```

```{r}
summary(led)
```

Все выглядит пристойно.

Оценим пропущенные значения.

```{r nas}
led %>% 
  is.na() %>% 
  sum()
```

Их нет, и это прекрасно.

# EDA

### 2

Посмотрим на взаимное распределение встречаемости туберкулеза и частоты самоубийств. Добавил цветом принадлежность государства к одному из континентов.

```{r fig.width=12, fig.height=9}
# Задаем палетку:
pal <- c("#DF536B", "#61D04F", "#2297E6", "#28E2E5", "#CD0BBC")
pal <- setNames(pal, levels(led$continent))

# Рисуем график
plot_ly(
  led,
  x = ~ `Tuberculosis Incidence`,
  y = ~ `Sucide Rate`,
  size = 1,
  color = ~ continent,
  colors = pal,
  alpha = 0.5,
  width = 1.5,
  height = 1.5
) %>% 
  layout(
      title = "Распределение частоты самоубийств в зависимости от\nвстречаемости туберкулеза у жителей различных континентов",
      xaxis = list(title = "Встречаемость туберкулеза",
                   zeroline = FALSE),
      yaxis = list(title = "Частота самоубийств",
                   zeroline = FALSE)
  )
```

Может, рисунок не очень хорош с точки зрения анализа данных, но как картина в духе пуантилизма он вполне неплох.

## Анализ данных

### 3

Проверим, различаются ли средняя ожидаемая продолжительность жизни в странах Африки и Америки.

Для сравнения применим t-тест Стьюдента. Чтобы понять, необходимо ли нам применять тест Уэлча, оценим равенство дисперсий.

```{r}
leveneTest(`Life expectancy` ~ continent, data = led %>% filter(continent %in% c("Africa", "Americas")))
```

Дисперсии негомогенны. Применим t-тест с поправкой Уэлча (t-тест по умолчанию в R)

```{r}
for_vis_tt <- led %>% 
  filter(continent %in% c("Africa", "Americas")) %>%
  rstatix::t_test(`Life expectancy` ~ continent) %>% 
  add_xy_position(x = "continent")
```

И визуализируем его:

```{r fig.width=15, fig.height=8}
led %>% filter(continent %in% c("Africa", "Americas")) %>% 
ggplot(aes(x=continent, y = `Life expectancy`))+
  geom_boxplot(fill="green")+
  labs(
    x = "Континент",
    y = "Ожидаемая\nпродолжительность жизни",
    title = "Распределение ожидаемой продолжительности жизни\nв странах Африки и Америки"
  )+
  theme_bw()+
  theme(
    axis.text.x = element_text(size=16),
    axis.text.y = element_text(size=16),
    axis.title.x = element_text(size=19), 
    axis.title.y = element_text(size=19),
    plot.title = element_text(size=23, hjust=5),
    legend.title = element_text(size=19),
    legend.text = element_text(size=16),
    legend.position = "bottom",
    legend.key.size = unit(1.5, "line"),
    strip.text.x = element_text(size=16)
  )+
  stat_pvalue_manual(for_vis_tt, tip.length = 0)
```

Средняя ожидаемая продолжительность жизни в странах Африки и Америки различаются.

### 4

Сделаем корреляционный анализ числовых переменных.

```{r fig.width=18, fig.height=11}
led_num <- led %>% 
  select(where(is.numeric) & !Year)

ggpairs(led_num, progress = FALSE)
```

График для 19-ти переменных выглядит довольно громоздко. Построим коррплот.

```{r fig.height=15, fig.width=15}


# Спирменовская корреляция -- потому что мы не проверяли распределение данных, а наверняка там найдется что-то ненормально-нелинейное
led_num_corr <- corr.test(led_num , method="spearman")
corr_plot <- ggcorrplot(led_num_corr$r, 
                        type = "lower", 
                        outline.col = "white", 
                        lab=TRUE, 
                        method = "circle", 
                        p.mat = led_num_corr$p,
                        title = "Скоррелированность количественных данных\nв датасете по ожидаемой продолжительности жизни",
                        legend.title = "Коэффициент\nкорреляции")
corr_plot
```

Наблюдается большое количество корреляций. Для примера можно привести сильную положительную скоррелированность между собой показателей вакцинации; продолжительности жизни с подушевым доходом и санитарно-гигиеническими нормами. Самая сильная (обратная) корреляция, что логично, наблюдается между урбанизацией и долей сельского населения.

### 5

Ростроим иерархическую кластеризацию

```{r, results='hide'}
# Делаем матрицу дистанций
led_num_scaled <- scale(led_num)

led_num_dist <- dist(led_num_scaled, 
                        method = "euclidean")
led_num_hc <- hclust(d = led_num_dist, 
                        method = "ward.D2")
fviz_dend(led_num_hc, 
          cex = 0.1)
```

### 6

Реализуем фитмэп

```{r fig.width=15, fig.height=9}
pheatmap(led_num_scaled, 
         show_rownames = FALSE, 
         clustering_distance_rows = led_num_dist,
         clustering_method = "ward.D2", 
         cutree_rows = 5,   # Прикидочное значение
         cutree_cols = length(colnames(led_num_scaled)),
         angle_col = 45, 
         main = "Dendrograms for clustering rows and columns with heatmap")
```

Мы наблюдаем следующие 2 группы скоррелированных переменных: 1) наличие иммунизации от кори, гепатита B и АКДС 2) экономические метрики: ВВП и ВНД

И 2 группы менее скоррелированных: 1) Безработица, встречаемость туберкулеза, лечение туберкулеза, смертность в ДТП, детская смертность и доля сельского населения. 2) Частота самоубийств, количество больничных коек (*страшная вырисовывается корреляция*), базовые санитарарные услуги, продолжительность жизни, доля городского населения, подушевой доход.

В данных мы выделили 4 субкластера (некий гиперпараметр), один из которых чрезвычайно мал (второй сверху на вертикальной дендрограмме) и характеризуется высокими значениями экономических показателей. Первый субкластер отличается очень низкими значениями иммунизации. Остальные три кластера выглядят достаточно негомогенными по большинству признаков (кроме экономических показателей).

### 7

Построим PCA

```{r}
led_full.pca <- prcomp(led_num_scaled) # Это уже отшкалированные данные, дополнительно не шкалируем

summary(led_full.pca)
```

Первые 5 компонент объясняют 75% вариации. Не идеально, но приемлемо. Посмотрим на соответствующий график.

```{r}
fviz_eig(led_full.pca, addlabels = T, ylim = c(0, 40))
```

Посмотрим на переменные

```{r}
fviz_pca_var(led_full.pca, col.var = "contrib")
```

Заметим, что все так же выделяется группа иммунизации, и две группы "слабо скоррелированных" переменных с фитмэпа.

```{r}
fviz_pca_var(led_full.pca, 
             select.var = list(contrib = 5),
             col.var = "contrib")
```

5 переменных, вносящих наибольший вклад -- все те же три переменные о проценте иммунизации, продолжительность жизни и младенческая смертность.

Посмотрим, кто вкладывается в избранные 6 главных компонент

```{r}
fviz_contrib(led_full.pca, choice = "var", axes = 1, top = 24) # 1
fviz_contrib(led_full.pca, choice = "var", axes = 2, top = 24) # 2
fviz_contrib(led_full.pca, choice = "var", axes = 3, top = 24) # 3
fviz_contrib(led_full.pca, choice = "var", axes = 4, top = 24) # 4
fviz_contrib(led_full.pca, choice = "var", axes = 5, top = 24) # 5

```

В первую наибольший вклад вносят продолжительность жизни, младенческая смертность, санусловия и соблюдение гигиены и правил приготовления пищи.

Во вторую -- переменные вакцинации.

В третью -- подавляющий вклад со стороны экономических показателей.

В четвертую -- частота самоубийств.

В пятую основной вклад вносит безработица.

### 8
Построим би~~-2~~плот

```{r fig.width=12, fig.height=9}
pca_plot <- ggbiplot::ggbiplot(led_full.pca, 
         scale=0, 
         groups = as.factor(led$continent), 
         labels = led$Country,
         labels.size = 2,
         alpha = 0.5,
         varname.size = 3,
         varname.abbrev = TRUE,
         varname.adjust = 0) + 
  theme_minimal()
ggplotly(pca_plot,
         tooltip = "label")
```

### 9

В ходе анализа биплота выявляются следующие закономерности:
1. В европейских странах иммунизация проводится с большой частотой. В африканских -- увы.
2. Азиатские страны представляют собой гетерогенную во всех отношениях группу.
3. Субкластер американских стран, Китай и его автономии имеют высокий уровень урбанизации и экономиечксих показателей (США и вовсе выглядят выбросом).
4. Большая часть африканских стран имеет высокую встречаемость туберкулеза, смертности от неинфекционных заболеваний, долю сельского населения и младенческую смертность. Это сопровождается более низкой ожидаемой продолжительностью жизни, меньшим числом больничных коек, более низким показателем чистоты топлива и технологий для приготовления пищи.
5. Наибольшая ожидаемая продолжительность жизни -- в Японии.
6. Если вы не ищете в жизни легких путей -- добро пожаловать в Сомали.

### 10

Построим UMAP на тех же данных.

```{r}
led_umap <- led %>% 
  select(where(is.numeric) | continent | Country)

umap_prep <- recipe(~., data = led_num) %>% 
  step_normalize(all_predictors()) %>% 
  step_umap(all_predictors()) %>%  
  prep() %>%
  juice()
```

```{r}
um <- umap_prep %>%
  ggplot(aes(UMAP1, UMAP2)) + 
  geom_point(aes(colour = led_umap$continent), 
             alpha = 0.7, size = 2) +
  labs(color = NULL) 
ggplotly(um)
```

На UMAP мы наблюдаем два облака точек. Одно включает в себя большинство африканских стран и несколько стран остальных регионов (кроме Европы).

Второе включает в себя все европейские страны, большую часть американских и азиатских, а также несколько стран Океании и Африки.

Отличия графиков.

 1. UMAP в отличие от PCA без фиксации seed невоспроизводим. Каждый раз он принимает несколько иную конформацию (иногда появляется третий маленький промежуточный и гетерогенный кластер).
 2. Визуализация UMAP сильно зависит от гиперпарметров (числа соседей и прочего), PCA же константен на одних и тех же данных.
 3. Это обуславливает тот аспект, что PCA может применять для анализа и построения умозаключений, а UMAP перимущественно для EDA.
 4. Визуально на UMAP кластера достаточно отдалены друг от друга (если, конечно, не задать им специфические настройки) за счет того, что этот метод в первую очередь ориентируется на расстояние между соседними точками, а не на глобальную картину в целом. PCA выглядит более диффузно. Говоря образно, можно сравнить UMAP со ступенчатым переходом, а PCA -- с континуумом.
 
### 11

Будем случайно удалять 5 переменных и строить PCA.

#### Попытка 1

Трансформируем данные
```{r}
set.seed(1929)
led_rand_1 <- led_num %>% 
  select(sample(1:ncol(led_num), size=ncol(led_num)-5))
led_rand_1_scaled <- scale(led_rand_1)
```


```{r}
led_rand_1.pca <- prcomp(led_rand_1_scaled) # Это уже отшкалированные данные, дополнительно не шкалируем

summary(led_rand_1.pca)
```


```{r}
fviz_eig(led_rand_1.pca, addlabels = T, ylim = c(0, 40))
```

```{r}
fviz_pca_var(led_rand_1.pca, col.var = "contrib")
```

```{r fig.width=12, fig.height=9}
pca_plot <- ggbiplot::ggbiplot(led_rand_1.pca, 
         scale=0, 
         groups = as.factor(led$continent), 
         labels = led$Country,
         labels.size = 2,
         alpha = 0.5,
         varname.size = 3,
         varname.abbrev = TRUE,
         varname.adjust = 0) + 
  theme_minimal()
ggplotly(pca_plot,
         tooltip = "label")
```

#### Попытка 2

```{r}
set.seed(1949)
led_rand_2 <- led_num %>% 
  select(sample(1:ncol(led_num), size=ncol(led_num)-5))
led_rand_2_scaled <- scale(led_rand_2)
```


```{r}
led_rand_2.pca <- prcomp(led_rand_2_scaled) # Это уже отшкалированные данные, дополнительно не шкалируем

summary(led_rand_2.pca)
```


```{r}
fviz_eig(led_rand_2.pca, addlabels = T, ylim = c(0, 40))
```

```{r}
fviz_pca_var(led_rand_2.pca, col.var = "contrib")
```

```{r fig.width=12, fig.height=9}
pca_plot <- ggbiplot::ggbiplot(led_rand_2.pca, 
         scale=0, 
         groups = as.factor(led$continent), 
         labels = led$Country,
         labels.size = 2,
         alpha = 0.5,
         varname.size = 3,
         varname.abbrev = TRUE,
         varname.adjust = 0) + 
  theme_minimal()
ggplotly(pca_plot,
         tooltip = "label")
```

#### Попытка 3

```{r}
set.seed(1988)
led_rand_3 <- led_num %>% 
  select(sample(1:ncol(led_num), size=ncol(led_num)-5))
led_rand_3_scaled <- scale(led_rand_3)
```


```{r}
led_rand_3.pca <- prcomp(led_rand_3_scaled) # Это уже отшкалированные данные, дополнительно не шкалируем

summary(led_rand_3.pca)
```


```{r}
fviz_eig(led_rand_3.pca, addlabels = T, ylim = c(0, 40))
```

```{r}
fviz_pca_var(led_rand_3.pca, col.var = "contrib")
```

```{r fig.width=12, fig.height=9}
pca_plot <- ggbiplot::ggbiplot(led_full.pca, 
         scale=0, 
         groups = as.factor(led$continent), 
         labels = led$Country,
         labels.size = 2,
         alpha = 0.5,
         varname.size = 3,
         varname.abbrev = TRUE,
         varname.adjust = 0) + 
  theme_minimal()
ggplotly(pca_plot,
         tooltip = "label")
```

В первых двух случаях мы достигаем порога объясненной дисперсии в 75% на 4-й компоненте. В 3-м -- между 4-й (73%) и 5-й (80%). "Стрелка-плоты" во всех трех случаях отличаются. Во втором случае сложнее сформировать ярко выраженные группы переменных (оттого и точки распределены более дисперсно). В первом же мы имеем иное направление компонент, из-за чего график несколько меняет свою "кранио-каудальную" структуру. Вместе с тем, основные паттерны полной версии PCA на них сохраняются (но, например, исчезает США-выброс). Третий вариант наиболее близок к оригинальной версии PCA.

Исключение отдельных переменных меняет вклад в общую дисперсию и структуру скоррелированности данных. Выпадение важных для объяснения структуры данных переменных может резко переменить отображение PCA.

### 12

Добавляем колокни типа: да-нет

```{r}
led_dummy <- led %>% 
  select(where(is.numeric) | continent & !Year) %>% 
  mutate(oceania = if_else(continent == "Oceania", 1, 0),
         africa = if_else(continent == "Africa", 1, 0)
  ) %>% 
  select(-c(continent, Year)) %>% 
  scale
```

```{r}
led_dummy.pca <- prcomp(led_dummy) # Это уже отшкалированные данные, дополнительно не шкалируем

summary(led_dummy.pca)
```


```{r}
fviz_eig(led_dummy.pca, addlabels = T, ylim = c(0, 40))
```

```{r}
fviz_pca_var(led_dummy.pca, col.var = "contrib")
```

```{r fig.width=12, fig.height=9}
pca_plot <- ggbiplot::ggbiplot(led_full.pca, 
         scale=0, 
         groups = as.factor(led$continent), 
         labels = led$Country,
         labels.size = 2,
         alpha = 0.5,
         varname.size = 3,
         varname.abbrev = TRUE,
         varname.adjust = 0) + 
  theme_minimal()
ggplotly(pca_plot,
         tooltip = "label")
```


Введение дамми-переменных выглядит нерациональным при текущем подходе. Они представлены в бинарном числовом формате, а после шкалирования превращаются в нечто совершенно невообразимое. Они не объясняют дополнительно часть дисперсии данных и не очень хорошо скоррелированы с остальными параметрами (что видно на биплоте и стрелка-плоте). Они не покрывают все 5 возможных вариантов континентов.