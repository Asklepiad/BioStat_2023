---
title: "Congenital cataract"
author: "Bogdan Sotnikov"
date: "2024-01-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
lapply(c("glue", "sandwich", "openxlsx", 
         "readxl", "rstatix", "gtsummary",
         "Hmisc", "ggcorrplot", "psych",
         "modelsummary", "GGally", "broom",
         "ggfortify", "lmtest", "ggResidpanel",
         "car", "tidyverse", "ggpubr",
         "plotly", "reshape", "kableExtra",
         "tidymodels", "dagitty"), require, character.only=TRUE)

# Функция для создания гистограмм
custom_hist <- function(df, variable_name){
  df %>% 
    ggplot()+
      geom_histogram(aes(x=pull(df[variable_name])), 
                     fill="green", 
                     color="black", 
                     bins =  ceiling(log2(nrow(df)) + 1))+
    theme_bw()+
    theme(axis.text.x = element_text(size=20),
      axis.text.y = element_text(size=20),
      axis.title.x = element_text(size=25),
      axis.title.y = element_text(size=25),
      plot.title = element_text(size=28, hjust=0.5))+
    labs(
      y = "Количество",
      x = variable_name,
      title = paste0("Распределение переменной ", variable_name)
    )
}

# Функция для создания барплотов
custom_bar <- function(df, variable_name){
  df %>% 
    ggplot()+
      geom_bar(aes(x=pull(df[variable_name])), 
                     color="black",
               fill="red")+
    theme_bw()+
    theme(axis.text.x = element_text(size=20),
      axis.text.y = element_text(size=20),
      axis.title.x = element_text(size=25),
      axis.title.y = element_text(size=25),
      plot.title = element_text(size=28, hjust=0.5))+
    labs(
      y = "Количество",
      x = variable_name,
      title = paste0("Категории переменной ", variable_name)
    )
}

# Функция для создания боксплотов
custom_boxplot <- function(df, var_num, var_fact){
  ggplot(df)+
    geom_boxplot(aes(x=pull(df[var_fact]), y=pull(df[var_num]), fill=pull(df[var_fact])), 
                   color="black")+
    labs(x = paste0("Градации переменнной ", var_fact),
         y = paste0("Значение переменной ", var_num),
         fill = var_fact,
         title = paste0("Диаграмма размаха переменной ", var_num, "\n", "по градациям переменной ", var_fact))+
    theme_bw()+
    theme(axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        axis.title.x = element_text(size=19),
        axis.title.y = element_text(size=19),
        plot.title = element_text(size=20, hjust=0.5),
        legend.title = element_text(size=19),
        legend.text = element_text(size=16))
}

# Функция для описательных статистик котов
catStat <- function(df, factorr){
  df %>% 
    dplyr::select(variant = {{  factorr }}) %>% 
    mutate(variant = as.character(variant) %>%  replace_na("no_data") %>% as.factor()) %>% 
    count(variant) %>% 
    dplyr::rename(number = n) %>% 
    mutate(proportionIntoGroup = round(number/sum(number),3),
           proportionCI = paste(
             round(binconf(number, sum(number), method = "wilson")[,2], 3),
             round(binconf(number, sum(number), method = "wilson")[,3], 3),
             sep="-"),
           variable = factorr) %>% 
  relocate(variable, .after=1)
}

# Функция стандартной ошибки
se <- function(x){
  sd(x, na.rm=TRUE)/sqrt(length(x))
}

# Функция для описательных статистик нумерических переменных
statistics <- list(
  Counts = ~ length(.x) %>% as.character(),
  NAs = ~ sum(is.na(.x)) %>% as.character(),
  Mean = ~ mean(.x, na.rm=TRUE) %>% round(3) %>% as.character(),
  SD = ~ sd(.x, na.rm=TRUE) %>% round(3) %>% as.character(),
  CI95 = ~ paste(round(mean(.x, na.rm=TRUE) - 1.96 * se(.x), 3),
                    round(mean(.x, na.rm=TRUE) + 1.96 * se(.x), 3), sep="-"),
  Median = ~ median(.x, na.rm=TRUE) %>% round(3) %>% as.character(),
  Quantiles = ~ paste(round(quantile(.x, probs=c(0.25), na.rm=TRUE), 3), 
                        round(quantile(.x, probs=c(0.75), na.rm=TRUE), 3), sep="-"),
  Iqr = ~ IQR(.x, na.rm=TRUE) %>% round(3) %>% as.character(),
  Min = ~ min(.x, na.rm=TRUE) %>% round(3) %>% as.character(),
  Max = ~ max(.x, na.rm=TRUE) %>% round(3) %>% as.character()
  )
```

# Дисклеймер

##################################################

##################################################

Работа сделана в несколько специфическом формате.

Первая часть представляет из себя фактически лабораторный журнал с кодом, написанный в весьма свободном стиле.

В требованиях, однако, указано, что `Отчет должен представлять связный текст`. Этому условию отвечает вторая часть (в оглавлении указана как `формальное описание`).

Большая часть кастомных функций лежит в первом "настроечном" чанке.

# Код и вольное описание

## Чтение и предобработка данных

Считываем данные

```{r}
dataract <- read_csv("congenital_cataract - congenital_cataract.csv")
```

Оценим переменные

```{r}
str(dataract)
```

```{r}
summary(dataract)
```

Не наблюдаем неадекватных значений. Вместе с тем первая колонка `...1` выглядит необязательной -- удалим ее. Также переведем из строкового в факторный вид переменные `side`, `strat` и `glau`.

```{r}
dataract <- dataract %>% 
  mutate(across(is.character, as.factor)) %>% 
  dplyr::select(!`...1`)
```

Оценим на наличие NA

```{r}
dataract %>% is.na %>% sum
```

Их нет, и это прекрасно.

## EDA

Построим гистограммы распределения для числовых переменных.

```{r fig.width=12, fig.height=16}
dataract_hists <- lapply(dataract %>% dplyr::select(where(is.numeric) & !id) %>% colnames, function(x) custom_hist(dataract, x))
combo_plot <- ggarrange(dataract_hists[[1]], 
                        dataract_hists[[2]], 
                        dataract_hists[[3]], 
                        ncol=1, nrow=3)
combo_plot
```

Обратим внимание, что у большинства пациентов острота зрения вдали выглядит не очень хорошо. Для остроты вблизи ситуация тоже не слишком радужная, но количество людей с околонулевыми значениями меньше, а с показателями более 50-ти -- больше. Возраст пациентов на повторном обследовании распространен относительно равномерно. Виден провал в районе 5-ти лет и пак ближе к 18-ти годам. Это выглядит логично, так как для маленьких детей могло пройти недостаточно времени (особенно в случае артифакии), поэтому они и не прибыли на повторный прием. В общем и целом распределение мало похоже на нормальное во всех трех случаях (особенно для острот зрения).

Посмотрим на количество факторных переменных в каждой из категорий (построим барплоты)

```{r fig.width=10, fig.height=18}
dataract_bars <- lapply(dataract %>% dplyr::select(where(is.factor)) %>% colnames, function(x) custom_bar(dataract, x))
combo_plot2 <- ggarrange(dataract_bars[[1]], 
                        dataract_bars[[2]], 
                        dataract_bars[[3]], 
                        ncol=1, nrow=3)
combo_plot2
```

Кажется, что немного чаще проводится операция артефакии, не развивается глаукома и оперируется правый глаз.

Есть предположение, что острота зрения ассоциирована с возрастом, а также, что острота зрения вблизи и вдали должны сильно коррелировать. Давайте посмотрим, и добавим данные о типе операции на графики.

```{r fig.width=12, fig.height=8}
ggplot(dataract)+
  geom_point(aes(x=bcdva, y=age_flwp, colour=strat))+
  theme_bw()+
  theme(axis.text.x = element_text(size=20),
    axis.text.y = element_text(size=20),
    axis.title.x = element_text(size=25),
    axis.title.y = element_text(size=25),
    plot.title = element_text(size=28, hjust=0.5))+
  labs(
    x = "Острота зрения вдаль",
    y = "Возраст",
    title = "Взаимораспределение возраста\nи остроты зрения вдаль"
  )
```

Для зрения вдаль получилась какая-то нелинейная картина: хорошие значения есть и в "старшем" и в "младшем" возрасте. А вот пациенты, которые приходили на прием в "среднем" возрасте, ~~переживают кризис~~ демонстрируют большую скученность около низких значений остроты зрения. При этом артефакичные пациенты чаще демонстрировали хорошие значения.

```{r fig.width=12, fig.height=8}
ggplot(dataract)+
  geom_point(aes(x=bcnva, y=age_flwp, colour=strat))+
  theme_bw()+
  theme(axis.text.x = element_text(size=20),
    axis.text.y = element_text(size=20),
    axis.title.x = element_text(size=25),
    axis.title.y = element_text(size=25),
    plot.title = element_text(size=28, hjust=0.5))+
  labs(
    x = "Острота зрения вблизи",
    y = "Возраст",
    title = "Взаимораспределение возраста\nи остроты зрения вблизи"
  )
```

Для зрения вблизи облако точек выглядит более разреженным, но общие "возрастно-остротные" тенденции сохраняются. И так же, максимальные значения зрения выше у артефакичных пациентов.

```{r fig.width=12, fig.height=8}
ggplot(dataract)+
  geom_point(aes(x=bcnva, y=bcdva, colour=strat))+
  theme_bw()+
  theme(axis.text.x = element_text(size=20),
    axis.text.y = element_text(size=20),
    axis.title.x = element_text(size=25),
    axis.title.y = element_text(size=25),
    plot.title = element_text(size=28, hjust=0.5))+
  labs(
    x = "Острота зрения вблизи",
    y = "Острота зрения вдаль",
    title = "Взаимораспределение остроты зрения\nвблизи и вдали"
  )
```

Это удивительно, но нет, жесткой линейной корреляции тут не видно. Много пациентов с хорошим зрением вблизи и плохим вдали, есть пациенты с довольно приемлемым зрением вдали и плохим вблизи (возможная гипотеза -- острота оценивалась без дополнительной коррекции. Тогда все довольно логично -- искусственный хрусталик неспособен к аккомодации, поэтому может быть исходно настроен на состоянии "вблизи"/"вдали", а для работы на втором расстоянии необходима очковая коррекция).

Было бы также интересно посмотреть, как сопоставляются между собой частоты наличия глаукомы и типа операции.

```{r fig.width=12, fig.height=8}
ggplot(dataract)+
  geom_bar(aes(x=strat, fill=glau), position="fill")
```

Частота вторичной (?) глаукомы при артефакии выглядит ниже.

Построим боксплоты для числовых переменных: остроты зрения на двух расстояниях и возраста по категориям: оперированному глазу, типу операции и факту наличия глаукомы.

```{r fig.width=20, fig.height=20}

box_list <- map(dataract %>% dplyr::select(where(is.factor)) %>% colnames, \(x) map(dataract %>% dplyr::select(where(is.numeric) & !id) %>% colnames, \(y) custom_boxplot(dataract, y , x)))

# Подзреваю, что я очень криво тут переношу данные из листа в комбинированную картинку. Если есть более изящный способ (а он наверняка есть), был бы признателен за замечание

ggarrange(box_list[[1]][[1]], box_list[[1]][[2]], box_list[[1]][[3]],
          box_list[[2]][[1]], box_list[[2]][[2]], box_list[[2]][[3]],
          box_list[[3]][[1]], box_list[[3]][[2]], box_list[[3]][[3]],
          ncol=3, nrow=3)

```

Видим, что пациенты с артефакией позже навещают врача, похоже что имеют несколько лучшие показатели зрения вдаль (как и пациенты с глаукомой). В целом глаукома не должна влиять на остроты зрения (поскольку при ней уменьшается поле зрения, а в центральной области до последних стадий может сохраняться высокая острота). Видим, что у остроты зрения вдаль стабильно низкие значения с несколькими "ясновидящими" выбросами.

Посмотрим на скоррелированность числовых переменных
```{r}
correlations <- corr.test(dataract %>% dplyr::select(where(is.numeric)), method = "spearman", adjust = "bonferroni")
cormatrix <- ggcorrplot(correlations$r, type = "lower", outline.col = "white", lab=TRUE, method = "circle", p.mat = correlations$p, sig.level = 0.05/(sum(1:length(dataract %>% dplyr::select(where(is.numeric)) %>% colnames))))
cormatrix
```

Числовые переменные нескоррелированы.

Приведем таблицы с более формальным описанием наших переменных.

```{r}
factor_patient_table <- lapply(dataract %>% 
         dplyr::select(where(is.factor)) %>% 
         colnames, 
       function(x) catStat(dataract, x) %>% 
        as.data.frame) %>% 
  do.call(rbind, .) %>% 
  dplyr::select(variable, variant, number, proportionIntoGroup, proportionCI) %>% 
  dplyr::rename(group_proportion = proportionIntoGroup,
         proportion_CI = proportionCI)
```


```{r}
numeric_patient_table <- dataract %>% dplyr::select(!id) %>% dplyr::rename(ageflwp=age_flwp) %>% 
  summarise(across(is.numeric, statistics)) %>%
  stack %>% 
  dplyr::rename(value = values) %>% 
  separate(ind, sep = "_", into = c("variable", "statistic")) %>% 
  pivot_wider(
    names_from = variable,
    values_from = value
  )
```

```{r}
factor_patient_table %>% 
  kbl() %>%
  kable_material_dark(full_width=FALSE)
```

```{r}
numeric_patient_table %>% 
  kbl() %>%
  kable_material_dark(full_width=FALSE)
```

## Тесты и модели

### 1.1.

> Какая стратегия предпочтительна для лечения врожденной катаракты, с точки зрения остроты зрения? Не используйте информацию о наличии глаукомы при ответе на этот вопрос. Оцените эффект стратегии без коррекции на ковариаты.

Самый простой вариант -- применить тест Стьюдента. Однако, как мы помним из эксплораторного анализа:
а) Данные довольно "кривые"
б) Их мало, и не похоже, чтобы ЦПТ здесь полноценно справилась с явно ненормальным распределением.

В поставленном ~~заказчиком~~ преподавателем вопросе нигде не фигурирует некий "средний уровень остроты зрения", засим предположим, что нулевая гипотеза формируется так: ни в одной из групп лечения не наличествует веротностное доминирование остроты зрения относительно другой группы. Применим тест Манна-Уитни.

А так как испытаний два, и это тоже своего рода ~~ученый~~ множественное тестирование, хорошо бы сделать поправку. Не жесткую, нет. Но условный Бенджамини-Хохберг бы сделал ситуацию чуть более приличным.

```{r}
mw_pvals <- map(dataract %>% dplyr::select(starts_with("bc")), \(x) wilcox.test(x ~ strat, data=dataract)$p.value) %>% 
  p.adjust(method = "BH") %>% print
```

Манн-Уитни различий не находит. Хотя для зрения вдаль кое-какие подозрения все-таки есть. Есть предположение, что нам не хватает мощности теста и числа пациентов, чтобы что-то действительно задетектировать. Взглянем на квартили:

```{r}
map(dataract %>% filter(strat=="Aphakia") %>% dplyr::select(starts_with("bc")), \(x) quantile(x) %>% round(3))
map(dataract %>% filter(strat!="Aphakia") %>% dplyr::select(starts_with("bc")), \(x) quantile(x) %>% round(3))
```

Да, размер эффекта для зрения вдаль косвенно подтверждает эту догадку.

Так как задание посвящено регрессии, сделаем линрегрессию, где предиктором будет тип операции, а целевой переменной -- острота зрения (через две точки можно провести лишь одну прямую, а именно две точки мы и аппроксимируем).

```{r}
vdal_1 <- lm(bcdva ~ strat, dataract)
summary(vdal_1)
```


```{r}
vbliz_1 <- lm(bcnva ~ strat, dataract)
summary(vbliz_1)
```

При заданном уровне альфы в 0.05, оценка коэффициентов b показывает, что они статистически незначимы.

Не до конца понимаю, есть ли смысл при текущей статзначимости коэффициентов оценивать выполнение допущений, а следовать прицнипу, что раз ~~доктор сказал в морг -- значит, в морг~~, в задании написано -- будем делать -- не очень хочется. Засим не будем для незначимых моделей оценивать критерии применимости.

### 1.2

> Оцените эффект стратегии с коррекцией на ковариаты. Обоснуйте необходимость включения каждой ковариаты в вашу модель.


Построим ДАГ и оценим, какие ковариаты мы можем включить в модель. Исходя из имеющихся данных, у нас нет оснований утверждать, что расположение глаза относительно сагиттальной плоскости и наличие глаукомы влияют на остроту зрения (кроме того, глаукому не рекомендовано включать в модель на данном этапе исследования). Едва ли влияет на что-либо идентификатор пациента. Засим, строим.

```{r}
dag1 <- dagitty( 'dag {
bb="0,0,1,1"
age_flwp [pos="0.470,0.539"]
bcdva [outcome,pos="0.841,0.901"]
glau [pos="0.466,0.753"]
strata [exposure,pos="0.052,0.889"]
age_flwp -> bcdva
strata -> age_flwp
strata -> bcdva
strata -> glau
}')

plot(graphLayout(dag1))
```

В онлайн-версии это выгляядело симпатичнее. Ну да ладно. Включим в модель возраст. Сразу добавим взаимодейтсвие факторов, поскольку фактически мы имеем три варианта: "молодые" пациенты с артефакией, "старые" пациенты с артефакией, "старые" пациенты с афакией (молодые пациенты с афакией есть, но это что-то околононсенсовое -- им совсем недавно делали вторую операцию).

```{r}
vdal_2 <- lm(bcdva ~ strat*age_flwp, dataract)
summary(vdal_2)
```

```{r}
dag2 <- dagitty( 'dag {
bb="0,0,1,1"
age_flwp [pos="0.470,0.539"]
bcnva [outcome,pos="0.841,0.901"]
glau [pos="0.466,0.753"]
strata [exposure,pos="0.052,0.889"]
age_flwp -> bcnva
strata -> age_flwp
strata -> bcnva
strata -> glau
}')

plot(graphLayout(dag2))
```


```{r}
vblizi_2 <- lm(bcnva ~ strat*age_flwp, dataract)
summary(vblizi_2)
```

Для зрения вдаль ничего, а вот модель для остроты зрения вблизи преобразилась (опустим, что R2 в целом 0.15, это сильно принижает торжественность момента). Значимость выявляется и для возраста (у афакичных пациентов с повышением возраста повторного обследования острота уменьшается) и для типа операции (снова уменьшение значения при смене типа на артефакию) и для взаимодействия (у артефакичных с повышением возраста острота зрения вблизи растет в положительную сторону по сравнению с афакичными того же возраста).

```{r}
ggplot(dataract, aes(y = bcdva, x = age_flwp, group = strat, colour = strat)) +
  geom_point() +
  geom_smooth(aes(color = strat), method = lm, se = TRUE)+
  theme_bw()
```



Так как мы использовали эффект пересечения, проверим, имеется ли ассоциация между целевой переменной и предикторами в отдельности. Кое-что мы уже знаем из EDA -- корреляция между остротой зрения вблизи и возрастом повторного обследования обнаружена не была. Отсутствие у нас достаточных данных для утверждения об ассоциацией между остротой зрения вблизи и типом лечения следует из модели в пункте 1.1 Конечно, можно применить тест хи-квадрат, но он обладает куда меньшей мощностью (и даже меньшей, чем тест Манна-Уитни, примененный в том же пункте 1.1). Таким образом мы не можем отвергнуть нулевую гиоптезу об отсутствии ассоциации между каждым из предикторов в отдельности и целевой переменной.

Проверим, соответствует ли модель критериям применимости.

```{r}
plot(resid(vblizi_2), fitted(vblizi_2))

plot(vblizi_2)
```

 - График остатков выглядит плохо: из-за малого числа наблюдений в левой части графика, и возрастающего числа точек в правой, линия "ломается".
 - Хвосты на квантиль-квантильном графике выглядят несколько ненормальными, но, в целом, не очень критичными (видимо, слишком "легкие" хвосты).
 - На графике со стандартизованными остатками за версту видно гетероскедастичность. Грустно.
 - Влиятельных наблюдений нет.
 
Вепроятная причина проблем с соответствием модели допущениям о линрегрессии -- в асимметричном распределении остроты зрения на близком расстоянии (на что намекала подсказка 1 из задания).

Попробуем починить это коррекцией на гетероскедастичность. Применим HC3, поскольку в лекции он рекомендовался для малых выборок (каюсь, не ознакомился должным образом с теоретической базой, засим слепо полагаюсь на полученную информацию).

```{r}
coeftest(vblizi_2, vcov. = vcovHC, type = "HC3")
```

### 2.1

> Какой эффект оказывает глаукома на остроту зрения? Зависит ли этот эффект от выбранной стратегии? Опишите эффект от терапии с учетом потенциального развития глаукомы. Какая терапия предпочтительнее с учетом потенциального развития глаукомы? Оцените эффект без коррекции на ковариаты.

Потворим действия из пукнта первого. Сначала тест Манна-Уитни (помним, что у нас мало наблюдений, они плохо распределены, поэтому t-тест -- не лучший выбор).

```{r}
mw_pvals <- map(dataract %>% dplyr::select(starts_with("bc")), \(x) wilcox.test(x ~ glau, data=dataract)$p.value) %>% 
  p.adjust(method = "BH") %>% print
```

Статзначимых отличий не наблюдаем. Нулевую гипотезу отвергнуть не можем.

```{r}
vdal_3 <- lm(bcdva ~ glau, dataract)
summary(vdal_3)
```

```{r}
vbliz_3 <- lm(bcnva ~ glau, dataract)
summary(vbliz_3)
```

Регрессия не показала ничего интересного (но это и на EDA было видно).

### 2.2

> Оцените эффект с коррекцией на ковариаты. Обоснуйте необходимость включения каждой ковариаты в вашу модель.

Теперь ДАГи выглядят иначе, поскольку мы предполагаем, что глаукома влияет на остроту зрения. В остальном логика включения предикторов в модель абсолютно идентична. 
```{r}
dag3 <- dagitty( 'dag {
bb="0,0,1,1"
age_flwp [pos="0.470,0.539"]
bcdva [outcome,pos="0.841,0.901"]
glau [pos="0.466,0.753"]
strata [exposure,pos="0.052,0.889"]
age_flwp -> bcdva
strata -> age_flwp
strata -> bcdva
strata -> glau
glau -> bcdva
}')

plot(graphLayout(dag3))
```

Добавляем возраст и стратегию лечения с учетом пересечения факторов, поскольку мы полагаем, что при большом стаже глаукомы, она может влиять на остроту зрения (зануляя его), а также для нас может иметь интерес эффект при наличии/отсутствии глаукомы для каждой из стратегий.

```{r}
vdal_4 <- lm(bcdva ~ strat*glau*age_flwp, dataract)
summary(vdal_4)
```

```{r}
dag4 <- dagitty( 'dag {
bb="0,0,1,1"
age_flwp [pos="0.470,0.539"]
bcnva [outcome,pos="0.841,0.901"]
glau [pos="0.466,0.753"]
strata [exposure,pos="0.052,0.889"]
age_flwp -> bcnva
strata -> age_flwp
strata -> bcnva
strata -> glau
glau -> bcnva
}')

plot(graphLayout(dag4))
```


```{r}
vbliz_4 <- lm(bcnva ~ strat*glau*age_flwp, dataract)
summary(vbliz_4)
```

Проверили-проверили.
И больше ничего.

(СТатзначимый коэффициент при сочетании факторов артефакии и возраста не несет дополнительной информации по сравнению с моделью из раздела 1.2)

### 3.1

> Как связана частота развития глаукомы с выбранной стратегией? Оцените эффект стратегии без коррекции на ковариаты.

Применим логистическую регрессию.

```{r}
glau1 <- glm(glau ~ strat, 
               dataract,
               family = binomial)
summary(glau1)
```

Логрегрессия говорит о том, что у нас недостаточно данных, чтобы отвергнуть H0 о равной частоте возникновения глаукомы в группах афакии и артефакии.

### 3.2

> Оцените эффект стратегии с коррекцией на ковариаты. Обоснуйте необходимость включения каждой ковариаты в вашу модель.

Рисуем ~~равносторонний треугольник~~ ДАГ для данного случая.

Единственная возможная ковариата -- возраст. Добавим ее в модель.

```{r}
dag4 <- dagitty('dag {
bb="0,0,1,1"
age_flwp [pos="0.490,0.574"]
glau [outcome,pos="0.879,0.868"]
strat [exposure,pos="0.130,0.870"]
age_flwp -> glau
strat -> age_flwp
strat -> glau
}'
)
plot(graphLayout(dag4))
```

```{r}
glau1 <- glm(glau ~ strat*age_flwp, 
               dataract,
               family = binomial)
summary(glau1)
```

Модель бессильна сказать что-либо внятное по глаукоме.

# Формальное описание

## Материалы и методы

В исследовании принимали участие 62 человека. В датасете присутствовали данные об остроте зрения на ближнем и дальнем расстоянии, возрасту повторного обследования, стратегии лечения, наличию вторичной глаукомы, оперированном глазе, индентификаторе пациента. Пропуски в данных отсутствовали.

В разведочном анализе данных для количественных переменных оценивались среднее, стандартное отклонение, стандартная ошибка среднего, 95%-ный доверительный интервал для среднего, медиана, межквартильный размах, 25-й и 75-й квартиль, минимум и максимум. Для факторных переменных оценивались представленность и доля каждой из категорий, а также доверительный интервал (по Уилсону) для доли.

Были построены гистограммы частот для количественных переменных и столбчатые диаграммы для факторных. Для оценки распределения количественных переменных в зависимости от градаций факторных были построены диаграммы размаха. Для визуального анализа взаимораспределения количественных переменных применялись диаграммы рассеяния. Для оценки мультиколлинеарности построена матрица коллинеарности.

Для проверки гипотезы о вероятностном доминировании использовался тест Манна-Уитни, с последующей коррекцией множественных сравнений тестом Бенджамини-Хохберга.

Для оценки ассоциаций между остротой зрения и рядом предикторов использовались модели линейной регрессии. Для компоновки многофакторной модели и оценки взаимодействия параметров применялись предварительно построенные направленные ациклические графы. Оценка применимости допущений использования модели выполнялась при помощи визуальной оценки квантиль-квантильных графиков остатков модели (нормальность распределения последних), графика распределения остатков, графиков Кука для детекции влиятельных наблюдений.

Для коррекции гетероскедастичности применялся sandwich-estimator HC3. 

Для оценки ассоциации межд фактом наличия глаукомы и рядом предикторов использовалась модель логистической регрессии. Для компоновки многофакторной модели и оценки взаимодействия параметров применялись предварительно построенные направленные ациклические графы.


## Краткие результаты и обсуждение

Диагностика модели, в которой целевой переменной являлась острота зрения вблизи, а предикторами -- возраст на момент повторного обследования и стратегия лечения показала статистическую значимость для обоих параметров, а также их взаимодействия.

Из модели видно, что для пациентов с точки зрения долгосрочного прогноза по остроте зрения вблизи предпочтительнее артефакия. При этом у биологически неинтерпретируемых пациентов нулевого возраста (центрирование для данной модели не проводилось) афакия выглядит более предпочтительной (острота зрения равна нулю для артефакии и 0.96 для афакии).
У детей, подвергавшихся афакии с повышением возраста повторного приема наблюдается уменьшение остроты зрения (на 0.06 в год). У пациентов же с артефакией каждый год после операции острота увеличивается на 0.09 (важно отметить, что речь идет о разных пациентах с разницей в возрасте в 1 год, а не про одного пациента год спустя. Скорее всего, это очевидно, но ремарка добавлена во изюежание ошибочной интерпретации).

Можно предположить, что у афакичных детей хуже долгосрочный прогноз из-за отсутствия физиологического давления хрусталика на глаз, постоянного наличия линзы для коррекции (а при ее отсутствии -- амблиопия), большего числа оперативных вмешательств, что может привести к неописанным долгосрочным осложнениям.