---
title: "Congenital cataract"
author: "Bogdan Sotnikov"
date: "2024-01-13"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
lapply(c("glue", "sandwich", "openxlsx", 
         "readxl", "rstatix", "gtbroom::tidy",
         "Hmisc", "ggcorrplot", "psych",
         "modelbroom::tidy", "GGally", "broom",
         "ggfortify", "lmtest", "ggResidpanel",
         "car", "tidyverse", "ggpubr",
         "plotly", "reshape", "kableExtra",
         "tidymodels", "dagitty"), require, character.only=TRUE)

# Функция для создания гистограмм
custom_hist <- function(df, variable_name){
  df %>% 
    ggplot()+
      geom_histogram(aes(x=pull(df[variable_name]), y = after_stat(count)/nrow(df)),
                     fill="green", 
                     color="black", 
                     bins =  ceiling(log2(nrow(df)) + 1))+
    geom_rug(aes(x=pull(df[variable_name])))+
    theme_bw()+
    theme(axis.text.x = element_text(size=20),
      axis.text.y = element_text(size=20),
      axis.title.x = element_text(size=25),
      axis.title.y = element_text(size=25),
      plot.title = element_text(size=28, hjust=0.5))+
    labs(
      y = "Количество",
      x = variable_name,
      title = paste0("Распределение переменной ", variable_name)
    )
}

# Функция для создания барплотов
custom_bar <- function(df, variable_name){
  df %>% 
    ggplot()+
      geom_bar(aes(x=pull(df[variable_name])), 
                     color="black",
               fill="red")+
    theme_bw()+
    theme(axis.text.x = element_text(size=20),
      axis.text.y = element_text(size=20),
      axis.title.x = element_text(size=25),
      axis.title.y = element_text(size=25),
      plot.title = element_text(size=28, hjust=0.5))+
    labs(
      y = "Количество",
      x = variable_name,
      title = paste0("Категории переменной ", variable_name)
    )
}

# Функция для создания боксплотов
custom_boxplot <- function(df, var_num, var_fact){
  ggplot(df)+
    geom_boxplot(aes(x=pull(df[var_fact]), y=pull(df[var_num]), fill=pull(df[var_fact])), 
                   color="black")+
    geom_jitter(aes(x=pull(df[var_fact]), y=pull(df[var_num]), fill=pull(df[var_fact])), 
                   color="black")+
    labs(x = paste0("Градации переменнной ", var_fact),
         y = paste0("Значение переменной ", var_num),
         fill = var_fact,
         title = paste0("Диаграмма размаха переменной ", var_num, "\n", "по градациям переменной ", var_fact))+
    theme_bw()+
    theme(axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        axis.title.x = element_text(size=19),
        axis.title.y = element_text(size=19),
        plot.title = element_text(size=20, hjust=0.5),
        legend.title = element_text(size=19),
        legend.text = element_text(size=16))
}

# Функция для описательных статистик котов
catStat <- function(df, factorr){
  df %>% 
    dplyr::select(variant = {{  factorr }}) %>% 
    mutate(variant = as.character(variant) %>%  replace_na("no_data") %>% as.factor()) %>% 
    count(variant) %>% 
    dplyr::rename(number = n) %>% 
    mutate(proportionIntoGroup = round(number/sum(number),3),
           proportionCI = paste(
             round(binconf(number, sum(number), method = "wilson")[,2], 3),
             round(binconf(number, sum(number), method = "wilson")[,3], 3),
             sep="-"),
           variable = factorr) %>% 
  relocate(variable, .after=1)
}

# Функция стандартной ошибки
se <- function(x){
  sd(x, na.rm=TRUE)/sqrt(length(x))
}

# Функция для описательных статистик нумерических переменных
statistics <- list(
  Counts = ~ length(.x) %>% as.character(),
  NAs = ~ sum(is.na(.x)) %>% as.character(),
  Mean = ~ mean(.x, na.rm=TRUE) %>% round(3) %>% as.character(),
  SD = ~ sd(.x, na.rm=TRUE) %>% round(3) %>% as.character(),
  CI95 = ~ paste(round(mean(.x, na.rm=TRUE) - 1.96 * se(.x), 3),
                    round(mean(.x, na.rm=TRUE) + 1.96 * se(.x), 3), sep="-"),
  Median = ~ median(.x, na.rm=TRUE) %>% round(3) %>% as.character(),
  Quantiles = ~ paste(round(quantile(.x, probs=c(0.25), na.rm=TRUE), 3), 
                        round(quantile(.x, probs=c(0.75), na.rm=TRUE), 3), sep="-"),
  Iqr = ~ IQR(.x, na.rm=TRUE) %>% round(3) %>% as.character(),
  Min = ~ min(.x, na.rm=TRUE) %>% round(3) %>% as.character(),
  Max = ~ max(.x, na.rm=TRUE) %>% round(3) %>% as.character()
  )
```

## Материалы и методы

В исследовании принимали участие 62 человека. В датасете присутствовали данные об остроте зрения на ближнем и дальнем расстоянии, возрасту повторного обследования, стратегии лечения, наличию вторичной глаукомы, оперированном глазе, индентификаторе пациента. Пропуски в данных отсутствовали.

В разведочном анализе данных для количественных переменных оценивались среднее, стандартное отклонение, стандартная ошибка среднего, 95%-ный доверительный интервал для среднего, медиана, межквартильный размах, 25-й и 75-й квартиль, минимум и максимум. Для факторных переменных оценивались представленность и доля каждой из категорий, а также доверительный интервал (по Уилсону) для доли.

Были построены гистограммы частот для количественных переменных и столбчатые диаграммы для факторных. Для оценки распределения количественных переменных в зависимости от градаций факторных были построены диаграммы размаха. Для визуального анализа взаимораспределения количественных переменных применялись диаграммы рассеяния. Для оценки мультиколлинеарности построена матрица коллинеарности.


Для оценки ассоциаций между остротой зрения и рядом предикторов использовались модели линейной регрессии. Для компоновки многофакторной модели и оценки взаимодействия параметров применялись предварительно построенные направленные ациклические графы. Оценка применимости допущений использования модели выполнялась при помощи визуальной оценки квантиль-квантильных графиков остатков модели (нормальность распределения последних), графика распределения остатков, графиков Кука для детекции влиятельных наблюдений.

Для коррекции гетероскедастичности применялся sandwich-estimator HC3. 

Для оценки ассоциации между фактом наличия глаукомы и рядом предикторов использовалась модель логистической регрессии. Для компоновки многофакторной модели и оценки взаимодействия параметров применялись предварительно построенные направленные ациклические графы.

## Чтение и предобработка данных

Считываем данные

```{r message=FALSE, results='hide'}
dataract <- read_csv("congenital_cataract - congenital_cataract.csv")
```

Оценим переменные

```{r comment=""}
str(dataract)
```

Не наблюдаем неадекватных значений. Вместе с тем первая колонка `...1` выглядит необязательной -- удалим ее. Также переведем из строкового в факторный вид переменные `side`, `strat` и `glau`.

```{r warning=FALSE, results='hide'}
dataract <- dataract %>% 
  mutate(across(is.character, as.factor)) %>% 
  dplyr::select(!`...1`)
```

Оценим на наличие NA

```{r comment=""}
dataract %>% is.na %>% sum
```

Их нет, и это прекрасно.

## EDA

Построим гистограммы распределения для числовых переменных.
`Использован аргумент plotlist в функции ggarrange`
`Гистограмма дополнена rug-plotом`
`Частоты заменены вероятностями (пришлось придумывать велосипед, хотя, возможно, он уже придуман)`
```{r fig.width=12, fig.height=16}
dataract_hists <- lapply(dataract %>% dplyr::select(where(is.numeric) & !id) %>% colnames, function(x) custom_hist(dataract, x))
combo_plot <- ggarrange(plotlist = dataract_hists, 
                        ncol=1, nrow=3)
combo_plot
```

Обратим внимание, что у большинства пациентов острота зрения вдали выглядит не очень хорошо. Для остроты вблизи ситуация тоже не слишком радужная, но количество людей с околонулевыми значениями меньше, а с показателями более 50-ти -- больше. Возраст пациентов на повторном обследовании распространен относительно равномерно. Виден провал в районе 5-ти лет и пак ближе к 18-ти годам. Это выглядит логично, так как для маленьких детей могло пройти недостаточно времени (особенно в случае артифакии), поэтому они и не прибыли на повторный прием. В общем и целом распределение мало похоже на нормальное во всех трех случаях (особенно для острот зрения).

Посмотрим на количество факторных переменных в каждой из категорий (построим барплоты)
`Использован аргумент plotlist в функции ggarrange`
```{r fig.width=10, fig.height=18}
dataract_bars <- lapply(dataract %>% dplyr::select(where(is.factor)) %>% colnames, function(x) custom_bar(dataract, x))
combo_plot2 <- ggarrange(plotlist = dataract_bars,
                        ncol=1, nrow=3)
combo_plot2
```

Кажется, что немного чаще проводится операция артефакии, не развивается глаукома и оперируется правый глаз.

Есть предположение, что острота зрения ассоциирована с возрастом, а также, что острота зрения вблизи и вдали должны сильно коррелировать. Давайте посмотрим, и добавим данные о типе операции на графики.
`Поменялись местами оси x и y`
```{r fig.width=12, fig.height=8}
ggplot(dataract)+
  geom_point(aes(x=age_flwp, y=bcdva, colour=strat))+
  theme_bw()+
  theme(axis.text.x = element_text(size=20),
    axis.text.y = element_text(size=20),
    axis.title.x = element_text(size=25),
    axis.title.y = element_text(size=25),
    plot.title = element_text(size=28, hjust=0.5))+
  labs(
    x = "Возраст",
    y = "Острота зрения вдаль",
    title = "Взаимораспределение возраста\nи остроты зрения вдаль"
  )
```

Для зрения вдаль получилась какая-то нелинейная картина: хорошие значения есть и в "старшем" и в "младшем" возрасте. А вот пациенты, которые приходили на прием в "среднем" возрасте, ~~переживают кризис~~ демонстрируют большую скученность около низких значений остроты зрения. При этом артефакичные пациенты чаще демонстрировали хорошие значения.
`Поменялись местами оси x и y`
```{r fig.width=12, fig.height=8}
ggplot(dataract)+
  geom_point(aes(x=age_flwp, y=bcnva, colour=strat))+
  theme_bw()+
  theme(axis.text.x = element_text(size=20),
    axis.text.y = element_text(size=20),
    axis.title.x = element_text(size=25),
    axis.title.y = element_text(size=25),
    plot.title = element_text(size=28, hjust=0.5))+
  labs(
    x = "Возраст",
    y = "Острота зрения вблизи",
    title = "Взаимораспределение возраста\nи остроты зрения вблизи"
  )
```

Для зрения вблизи облако точек выглядит более разреженным, но общие "возрастно-остротные" тенденции сохраняются. И так же, максимальные значения зрения выше у артефакичных пациентов.

```{r fig.width=12, fig.height=8}
ggplot(dataract)+
  geom_point(aes(x=bcnva, y=bcdva, colour=strat))+
  theme_bw()+
  theme(axis.text.x = element_text(size=20),
    axis.text.y = element_text(size=20),
    axis.title.x = element_text(size=25),
    axis.title.y = element_text(size=25),
    plot.title = element_text(size=28, hjust=0.5))+
  labs(
    x = "Острота зрения вблизи",
    y = "Острота зрения вдаль",
    title = "Взаимораспределение остроты зрения\nвблизи и вдали"
  )
```

Это удивительно, но нет, жесткой линейной корреляции тут не видно. Много пациентов с хорошим зрением вблизи и плохим вдали, есть пациенты с довольно приемлемым зрением вдали и плохим вблизи (возможная гипотеза -- острота оценивалась без дополнительной коррекции. Тогда все довольно логично -- искусственный хрусталик неспособен к аккомодации, поэтому может быть исходно настроен на состоянии "вблизи"/"вдали", а для работы на втором расстоянии необходима очковая коррекция).

Было бы также интересно посмотреть, как сопоставляются между собой частоты наличия глаукомы и типа операции.

```{r fig.width=12, fig.height=8}
ggplot(dataract)+
  geom_bar(aes(x=strat, fill=glau), position="fill")
```

Частота глаукомы при артефакии выглядит ниже.

Построим боксплоты для числовых переменных: остроты зрения на двух расстояниях и возраста по категориям: оперированному глазу, типу операции и факту наличия глаукомы.
`Здесь plotlist справился наполовину: лист листов он не взял, поэтому появилась другая конструкция (но все же сильно более лакончиная)`
`Боксплот дополнен джиттер-плотом`
```{r fig.width=20, fig.height=20}

box_list <- map(dataract %>% dplyr::select(where(is.factor)) %>% colnames, \(x) map(dataract %>% dplyr::select(where(is.numeric) & !id) %>% colnames, \(y) custom_boxplot(dataract, y , x)))

ggarrange(plotlist=map(box_list, \(x) ggarrange(plotlist=x,
          ncol=1, nrow=3)), ncol=3, nrow=1)
```

Видим, что пациенты с артефакией позже навещают врача, похоже что имеют несколько лучшие показатели зрения вдаль (как и пациенты с глаукомой). В целом глаукома не должна влиять на остроты зрения (поскольку при ней уменьшается поле зрения, а в центральной области до последних стадий может сохраняться высокая острота). Видим, что у остроты зрения вдаль стабильно низкие значения с несколькими "ясновидящими" выбросами.

Посмотрим на скоррелированность числовых переменных
```{r}
correlations <- corr.test(dataract %>% dplyr::select(where(is.numeric)), method = "spearman", adjust = "bonferroni")
cormatrix <- ggcorrplot(correlations$r, type = "lower", outline.col = "white", lab=TRUE, method = "circle", p.mat = correlations$p, sig.level = 0.05/(sum(1:length(dataract %>% dplyr::select(where(is.numeric)) %>% colnames))))
cormatrix
```

Числовые переменные нескоррелированы.

Приведем таблицы с более формальным описанием наших переменных.

```{r warning=FALSE, message=FALSE, comment="", results='hide'}
factor_patient_table <- lapply(dataract %>% 
         dplyr::select(where(is.factor)) %>% 
         colnames, 
       function(x) catStat(dataract, x) %>% 
        as.data.frame) %>% 
  do.call(rbind, .) %>% 
  dplyr::select(variable, variant, number, proportionIntoGroup, proportionCI) %>% 
  dplyr::rename(group_proportion = proportionIntoGroup,
         proportion_CI = proportionCI)
```


```{r warning=FALSE, message=FALSE, comment="", results='hide'}
numeric_patient_table <- dataract %>% dplyr::select(!id) %>% dplyr::rename(ageflwp=age_flwp) %>% 
  summarise(across(is.numeric, statistics)) %>%
  stack %>% 
  dplyr::rename(value = values) %>% 
  separate(ind, sep = "_", into = c("variable", "statistic")) %>% 
  pivot_wider(
    names_from = variable,
    values_from = value
  )
```

```{r}
factor_patient_table %>% 
  kbl() %>%
  kable_material_dark(full_width=FALSE)
```

```{r}
numeric_patient_table %>% 
  kbl() %>%
  kable_material_dark(full_width=FALSE)
```

## Тесты и модели

 - `Добавлены ДИ для коээффициентов регрессии`

 - `Диагностика проведена для моделей линейной регрессии с ковариатами`

 - `Добавлена и изменена интерпретация коэффициентов`

### 1.1.

> Какая стратегия предпочтительна для лечения врожденной катаракты, с точки зрения остроты зрения? Не используйте информацию о наличии глаукомы при ответе на этот вопрос. Оцените эффект стратегии без коррекции на ковариаты.

`Удален признанный неудачным подход с тестом Манна-Уитни и квантилями`

Так как задание посвящено регрессии, сделаем линрегрессию, где предиктором будет тип операции, а целевой переменной -- острота зрения (через две точки можно провести лишь одну прямую, а именно две точки мы и аппроксимируем).

`Дисклеймер: в первом и втором задании нарушается одно из допущений линрегрессии -- о гетероскедастичности наблюдений. Это связано с хараткером распредления переменной в достаточно узком диапазоне значений -- от 0 до 1, что при приближении к маргинальным значениям делает гомоскедастичность крайне труднодостижимой (значения при любом распределении будут "обрезаться с одной из сторон")`.

```{r}
vdal_1 <- lm(bcdva ~ strat, dataract)
broom::tidy(vdal_1, conf.int=TRUE) %>% 
  kbl %>% 
  kable_material_dark()
```

`Проинтерпретируем коэффициенты модели.`
Мы ожидаем, что для пациентов с афакией средняя острота зрения вдаль будет составлять 0.12 (95% ДИ 0.04-0.17).
Для пациентов с артфакией мы ожидаем, что их острота зрения вдаль будет в среднем на 0.08 больше (95% ДИ -0.02-0.17). Так как доверительный интервал включает 0, в нашем случае говорить о преимущественном среднем улучшении или ухдшении зрения после артефакии по сравнению с афакией не приходится (на что намекает и p-value=0.12, который больше выбранного нами порога для ошибки первого рода в 5%).



```{r}
vbliz_1 <- lm(bcnva ~ strat, dataract)
broom::tidy(vbliz_1, , conf.int=TRUE)%>% 
  kbl %>% 
  kable_material_dark()
```

`Проинтерпретируем коэффициенты`
Мы ожидаем, что для пациентов с афакией средняя острота вблизи вдаль будет составлять 0.29 (95% ДИ 0.18-0.40).
Для пациентов с артфакией мы ожидаем, что их острота зрения вдаль будет в среднем на 0.05 больше (95% ДИ -0.09-0.20). Так как доверительный интервал включает 0, в нашем случае говорить о преимущественном среднем улучшении или ухдшении зрения после артефакии по сравнению с афакией не приходится (на что намекает и p-value=0.45, который больше выбранного нами порога для ошибки первого рода в 5%).


### 1.2

> Оцените эффект стратегии с коррекцией на ковариаты. Обоснуйте необходимость включения каждой ковариаты в вашу модель.


Построим ДАГ и оценим, какие ковариаты мы можем включить в модель. Не будем включать идентификатор пациента, поскольку преполагаем, что он не должен влиять остальные факторы. Далее в ходе построения моделей будем использовать отдельные компоненты нашего графа. 

В ходе диалога с заказчиком от 25.01.24 не был достигнут консенсус по поводу влияния глаукомы на `остроту` зрения. Было принято решение включить компонент, отражающий влияние глаукомы на остроту зрения, поскольку на последней стадии глаукома действительно влияет на остроту, зануляя ее. При этом на более ранних стадиях она может не влиять на остроту вообще, уменьшая лишь `поля` зрения.

`ДАГ изменен`
```{r}
dag1 <- dagitty( 'dag {
bb="0,0,1,1"
age_flwp [pos="0.470,0.539"]
bcdva [outcome,pos="0.841,0.901"]
glau [pos="0.466,0.753"]
side [pos="0.467,0.381"]
strata [exposure,pos="0.052,0.889"]
age_flwp -> bcdva
age_flwp -> strata
glau -> bcdva
side -> bcdva
strata -> bcdva
strata -> glau
}')

plot(graphLayout(dag1))
```

Наблюдаем конфаундинг, создаваемый переменной возраста -- он влияет как на тип операции, так и, как следует из наших наблюдений и EDA (на исход). Добавим взаимодейтсвие факторов: возраста и типа операции, `поскольку мы предполагаем, что возраст оказывает модифицирующее влияние на тип операции, и мы в этом случае хотим проверить зависимость одной переменной от другой.`

`Также добавим в модель информацию о стороне операции, поскольку заказчик утверждает, что могут быть биологические предпосылки для ассоциации остроты и вышеупомянутого фактора. Мне это представляется несколько сомнительным, но, будем надеяться, что включение переменной в качестве ковариаты увеличит точность оценки коэффициентов.`



```{r}
vdal_2 <- lm(bcdva ~ strat*age_flwp + side, dataract)
broom::tidy(vdal_2, conf.int=TRUE)%>% 
  kbl %>% 
  kable_material_dark()
```

`Проверим, соответствует ли модель критериям применимости.`

```{r}
plot(resid(vdal_2), fitted(vdal_2))

plot(vdal_2)
```

 - График остатков выглядит не очень хорошо: из-за малого числа наблюдений в левой части графика, и возрастающего числа точек в правой, линия "ломается".
 - Квантиль-квантильный график намекает на скошенное распределение.
 - На графике со стандартизованными остатками видно гетероскедастичность. Это может быть объяснено узким диапазоном возможного распределения целевой переменной (от 0 до 1), что при приближении к маргинальным значениям априорно не позволяет гомооскедастичности случиться.
 - Влиятельных наблюдений нет.

Попробуем починить упомянутую выше проблему с гетероскедастичностью коррекцией на оную. Применим HC3, поскольку в лекции он рекомендовался для малых выборок.

```{r}
coe <- coeftest(vdal_2, vcov. = vcovHC, type = "HC3")
ci <- coe %>% confint
cbind(coe %>% as.table,
      ci%>% as.table)%>% 
  kbl %>% 
  kable_material_dark()
```

`Проинтерпретируем результаты`
Мы ожидаем, что средняя острота зрения вдали после операции афакии на левом глазу при возрасте повторного наблюдения 0 составляет 0.34 (95% ДИ 0.11-0.57). После операции артефакии при прочих равных обстоятельствах острота в среднем ниже на 0.03 (95% ДИ -0.41-0.35). Так как доверительный интервал включает 0, в нашем случае говорить о преимущественном среднем улучшении или ухудшении зрения после артефакии по сравнению с афакией при прочих равных обстоятельствах не приходится. Для операции афакии с увеличением возраста повторного обследования на один год при прочих равных обстоятельствах острота зрения в среднем изменяется на -0.021 (95% ДИ -0.041--0.002). Для операции артефакии с увеличением возраста на один год и при прочих равных обстоятельствах острота зрения в среднем изменяется на 0.01 (95% ДИ -0.02-0.04). Так как доверительный интервал включает 0, в нашем случае говорить о преимущественном среднем улучшении или ухудшении зрения с течением времени после операции артефакии при прочих равных обстоятельствах не приходится. После операции на правом глазу при прочих равных обстоятельствах острота зрения в среднем отличается на -0.02  (95% ДИ -0.11-0.08). Так как доверительный интервал включает 0, в нашем случае говорить о преимущественном среднем улучшении или ухудшении зрения после операции на правом глазу по сравнению с состоянием после операции на левом глазу при прочих равных обстоятельствах не приходится.


```{r}
dag2 <- dagitty( 'dag {
bb="0,0,1,1"
age_flwp [pos="0.470,0.539"]
bcnva [outcome,pos="0.841,0.901"]
glau [pos="0.466,0.753"]
side [pos="0.467,0.381"]
strata [exposure,pos="0.052,0.889"]
age_flwp -> bcnva
age_flwp -> strata
glau -> bcnva
side -> bcnva
strata -> bcnva
strata -> glau
}')

plot(graphLayout(dag2))
```

Строим модель для остроты зрения вблизи.

```{r}
vblizi_2 <- lm(bcnva ~ strat*age_flwp + side, dataract)
broom::tidy(vblizi_2, conf.int=TRUE)%>% 
  kbl %>% 
  kable_material_dark()
```




Проверим, соответствует ли модель критериям применимости.

```{r}
plot(resid(vblizi_2), fitted(vblizi_2))

plot(vblizi_2)
```

 - График остатков выглядит плохо: из-за малого числа наблюдений в левой части графика, и возрастающего числа точек в правой, линия "ломается".
 - Хвосты на квантиль-квантильном графике выглядят несколько ненормальными, но, в целом, не очень критичными.
 - На графике со стандартизованными остатками за версту видно гетероскедастичность. `Это может быть объяснено узким диапазоном возможного распределения целевой переменной (от 0 до 1), что при приближении к маргинальным значениям априорно не позволяет гомооскедастичности случиться.`
 - Влиятельных наблюдений нет.
 

Попробуем починить упомянутую выше проблему с гетероскедастичностью коррекцией на оную. Применим HC3, поскольку в лекции он рекомендовался для малых выборок.

```{r}
coe <- coeftest(vblizi_2, vcov. = vcovHC, type = "HC3")
ci <- coe %>% confint
cbind(coe %>% as.table,
      ci%>% as.table)%>% 
  kbl %>% 
  kable_material_dark()
```

Мы ожидаем, что средняя острота зрения вблизи после операции афакии на левом глазу при возрасте повторного наблюдения 0 составляет 0.95 (95% ДИ 0.57-1.32*) (*привет доверительному интервалу Вальда в связи с выходом за границы возможного распределения). После операции артефакии при прочих равных обстоятельствах острота в среднем ниже на -1.02 (95% ДИ -1.47*--0.55). Для операции афакии с увеличением возраста повторного обследования на один год при прочих равных обстоятельствах острота зрения в среднем изменяется на -0.07 (95% ДИ -0.10--0.03). Для операции артефакии с увеличением возраста на один год и при прочих равных обстоятельствах острота зрения в среднем изменяется на 0.10 (95% ДИ 0.06-0.14). После операции на правом глазу при прочих равных обстоятельствах острота зрения в среднем отличается на 0.07  (95% ДИ -0.06-0.21). Так как доверительный интервал включает 0, в нашем случае говорить о преимущественном среднем улучшении или ухудшении зрения после операции на правом глазу по сравнению с состоянием после операции на левом глазу при прочих равных обстоятельствах не приходится.


### 2.1

> Какой эффект оказывает глаукома на остроту зрения? Зависит ли этот эффект от выбранной стратегии? Опишите эффект от терапии с учетом потенциального развития глаукомы. Какая терапия предпочтительнее с учетом потенциального развития глаукомы? Оцените эффект без коррекции на ковариаты.

Потворим действия из пукнта первого. 

`Удален неудачный подход с тестом Манна-Уитни`

```{r}
vdal_3 <- lm(bcdva ~ glau, dataract)
broom::tidy(vdal_3, conf.int=TRUE)%>% 
  kbl %>% 
  kable_material_dark()
```

`Проинтерпретируем коэффициенты`
Мы ожидаем, что для пациентов с без глаукомы средняя острота зрения вдаль будет составлять 0.18 (95% ДИ 0.11-0.24).
Для пациентов с глаукомой мы ожидаем, что их острота зрения вдаль будет в среднем на 0.03 меньше (95% ДИ -0.14-0.06). Так как доверительный интервал включает 0, в нашем случае говорить о преимущественном среднем улучшении или ухдшении зрения при наличии глаукомы по сравнению с отсутствием оной не приходится (на что намекает и p-value=0.47, который больше выбранного нами порога для ошибки первого рода в 5%).

```{r}
vbliz_3 <- lm(bcnva ~ glau, dataract)
broom::tidy(vbliz_3, conf.int=TRUE)%>% 
  kbl %>% 
  kable_material_dark()
```

`Проинтерпретируем коэффициенты`
Мы ожидаем, что для пациентов с без глаукомы средняя острота зрения вблизи будет составлять 0.34 (95% ДИ 0.25-0.44).
Для пациентов с глаукомой мы ожидаем, что их острота зрения вдаль будет в среднем на 0.04 меньше (95% ДИ -0.19-0.09). Так как доверительный интервал включает 0, в нашем случае говорить о преимущественном среднем улучшении или ухдшении зрения при наличии глаукомы по сравнению с отсутствием оной не приходится (на что намекает и p-value=0.49, который больше выбранного нами порога для ошибки первого рода в 5%).

### 2.2

> Оцените эффект с коррекцией на ковариаты. Обоснуйте необходимость включения каждой ковариаты в вашу модель.

Добавляем возраст и стратегию лечения, а также эффект пересечения глаукомы и типа операции. Полагаем, что операция может влиять на возникновение глаукомы, засим мы хотим проверить зависимость одной переменной от другой. В остальном обоснование во многом совпадает с пунктом 1.2

```{r}
vdal_4 <- lm(bcdva ~ strat+glau+age_flwp+glau*strat, dataract)
broom::tidy(vdal_4, conf.int=TRUE)%>% 
  kbl %>% 
  kable_material_dark()
```

`Проверим, соответствует ли модель допущениям линрегрессии`

```{r}
plot(resid(vdal_4), fitted(vdal_4))

plot(vdal_4)
```

 - График остатков выглядит не слишком хорошо: большое количество остатков смещается на небольшую дистанцию  в отрицательную сторону относительно линии, небольшое количество остатков смещается на бОльшую дистанцию в положительную сторону. Это обеспечивает изламывающуюся линию и "некрасивое" распределение остатков.
 - Квантиль-квантильный график намекает на скошенное распределение.
 - На графике со стандартизованными остатками видно гетероскедастичность. Это может быть объяснено узким диапазоном возможного распределения целевой переменной (от 0 до 1), что при приближении к маргинальным значениям априорно не позволяет гомооскедастичности случиться.
 - Влиятельных наблюдений нет.
 
Попробуем починить упомянутую выше проблему с гетероскедастичностью коррекцией на оную. Применим HC3, поскольку в лекции он рекомендовался для малых выборок.

```{r}
coe <- coeftest(vdal_4, vcov. = vcovHC, type = "HC3")
ci <- coe %>% confint
cbind(coe %>% as.table,
      ci%>% as.table)%>% 
  kbl %>% 
  kable_material_dark()
```

`Проинтерпретируем`
Мы ожидаем, что средняя острота зрения вдаль у пациентов без глаукомы после операции афакии при возрасте повторного наблюдения  составляет 0.22 (95% ДИ 0.01-0.43). После операции артефакии при прочих равных обстоятельствах острота в среднем выше на 0.15 (95% ДИ 0.03-0.26). При наличии глаукомы при прочих равных обстоятельствах острота зрения в среднем на 0.03 больше (95% ДИ -0.09-0.17). Для операции артефакии при наличии глаукомы и при прочих равных обстоятельствах острота зрения в среднем меньше на -0.12 (95% ДИ -0.33-0.09).

```{r}
vbliz_4 <- lm(bcnva ~ strat+glau+age_flwp+glau*strat, dataract)
broom::tidy(vbliz_4, conf.int=TRUE)%>% 
  kbl %>% 
  kable_material_dark()
```

`Проверим, соответствует ли модель допущениям линрегрессии`

```{r}
plot(resid(vbliz_4), fitted(vbliz_4))

plot(vbliz_4)
```

 - График остатков сравнительно неплохо (особенно по сравнению с предыдущими моделями): Облако точек не выглядит слишком гомогенным, но, возможно, это связано с относительно небольшим числом наблюдений. Говорить о возможной кластеризации в данном случае затруднительно, несмотря на некоторые скопления точек, поскольку при обсуждении-консультации с заказчиком упоминалось, что данный феномен возникает при числе потенциальных кластеров около 10-ти и выше.
 - Квантиль-квантильный график несколько намекает на скошенное распределение.
 - График выглядит относительно гомоскедастичным.
 - Влиятельных наблюдений нет.
 
Рискну предположить, что в этом случае коррекция не требуется.

`Проинтерпретируем`
Мы ожидаем, что средняя острота зрения вблизи у пациентов без глаукомы после операции афакии при возрасте повторного наблюдения  составляет 0.16 (95% ДИ -0.11-0.44). После операции артефакии при прочих равных обстоятельствах острота в среднем выше на 0.14 (95% ДИ -0.05-0.34). При наличии глаукомы при прочих равных обстоятельствах острота зрения в среднем на 0.10 больше (95% ДИ -0.11-0.33). Для операции артефакии при наличии глаукомы и при прочих равных обстоятельствах острота зрения в среднем меньше на -0.12 (95% ДИ -0.33-0.09).
 
### 3.1

> Как связана частота развития глаукомы с выбранной стратегией? Оцените эффект стратегии без коррекции на ковариаты.

Применим логистическую регрессию.

```{r}
glau1 <- glm(glau ~ strat, 
               dataract,
               family = binomial)
broom::tidy(glau1, conf.int=TRUE) %>% 
  kbl %>% 
  kable_material_dark()
```

`Проинтерпретируем`
Видим, что логарифм ОШ для возникновения глаукомы при применении артефакии по сравнению с афакией равен -0.53 (95% ДИ -1.58-0.5). Поскольку ДИ логарифма ОШ включает 0 (что при возведении на него даст единицу), не можем говорить о более часто или редко возникающей глаукоме при афакии по сравнению с артефакией.

### 3.2

> Оцените эффект стратегии с коррекцией на ковариаты. Обоснуйте необходимость включения каждой ковариаты в вашу модель.

`Исходя из построенного нами ДАГа, единственной переменной, связанной как с типом операции, так и с глаукомой, является возраст повторного обследования. Но он является коллайдером, а потому не может быть включен в исследование в качестве ковариаты. Предлагается не строить модель с ковариатами для сей задачи на представленных данных.`
